import{l as S,r as n,aP as v,aH as y,aQ as P,aR as H,m as I,j as s,E as A}from"./index-CXHULY4u.js";import{C as U,u as T,W,a as B,I as O,U as _,S as M,P as V}from"./page-Smuc2VFM.js";import{u as F}from"./use-navigate-BH3vcUeL.js";import{A as G}from"./index-Dtu2nuol.js";import{B as $}from"./index-BPmRLpnv.js";import{S as E}from"./index-Baf81WNP.js";import{P as K}from"./constant-Dqe_e0L0.js";import{S as N,c as Q}from"./Subject-CT8M7xMz.js";import{i as L}from"./is-phone-DTEOzYrv.js";import"./button-DHQucCMe.js";import"./index-DWCwO-n1.js";import"./asyncToGenerator-BkbE2unC.js";import"./reactNode-CEH14AYp.js";import"./PurePanel-CpacqMRC.js";import"./UnstableContext-Di9e-Ta6.js";import"./compact-item-BSB2nsO6.js";import"./LoadingOutlined-B_sMKgZN.js";import"./pickAttrs-DH0_vly7.js";import"./useLocale-DaBTclAC.js";import"./BaseInput-O-mBI8Cb.js";import"./index-z5Xdh7qt.js";import"./index-AgyNRA-j.js";import"./DownOutlined-iXoXln9O.js";import"./index-C4XMjAec.js";import"./index-4nKQX8jH.js";import"./index-ydlln-kV.js";import"./fade-DBivDqo0.js";import"./iconBase-BCg7Lj2D.js";import"./index-B4g9YTQJ.js";import"./index-ATq82YkN.js";var x=(e=>(e.PREVIEW_IMAGE="preview_image",e))(x||{});const C=new N;function q(e){var r;C.next(e),(r=e.ext)!=null&&r.disableAutoLogger||S.event("pht-action",e)}const z=Q(C);function D(e){return new Proxy({async action(r,t,a=[]){var d,g;const{promise:i,resolve:p}=v(),l=({data:{result:f}})=>{var o;p(f),(o=e.current)==null||o.removeEventListener("message",l)};return(d=e.current)==null||d.addEventListener("message",l),(g=e.current)==null||g.postMessage({action:r,option:t},a),i}},{get(r,t,a){if(t in r)return Reflect.get(r,t,a);const i=e.current[t];return typeof i=="function"?i.bind(e.current):i}})}function Y(e,r){const t=n.useRef(null),a=n.useMemo(()=>D(t),[]);return n.useEffect(()=>(t.current=new Worker(e,{type:"module"}),r==null||r(a),()=>{var i;(i=t.current)==null||i.terminate()}),[e]),a}const J=new URL("/desktop-tools/assets/compose-worker-DQclmwbB.ts",import.meta.url);function X(){const e=n.useRef(document.createElement("canvas")),r=n.useRef({dirty:!0,width:0,height:0,images:[],jitterRange:30,replaceColor:"#000000",filterList:[]}),t=Y(J,P(o=>{S.warn("如果需要调整本页面相关内容, 请先关闭 React 的严格渲染模式"),H(()=>{var m;const c=(m=e.current)==null?void 0:m.transferControlToOffscreen();!c||!o||o.action("init",{offscreen:c},[c])})})),[a,i]=n.useState(""),[p,l]=n.useState(!1),[d,g]=n.useState("");n.useEffect(()=>{const o=c=>{g(c.message),l(!1)};return t.addEventListener("error",o),()=>{t.removeEventListener("error",o)}},[t]);const f=n.useCallback(async(o,c={})=>{if(g(""),!e.current||!o.length){i("");return}const{replaceColor:m="#000000",jitterRange:h=30}=c;l(!0);const u=r.current;return Promise.resolve().then(()=>{if(!(u.images.toString()===o.toString()&&u.jitterRange===h&&u.replaceColor===m))return u.dirty=!0,u.images=o,u.jitterRange=h,t.action("compose",{imgs:o,options:c})}).then(()=>{var R;if(!(!u.dirty&&u.filterList.toString()===((R=c.filterList)==null?void 0:R.toString())))return u.dirty=!0,u.filterList=c.filterList||[],t.action("filter",{filterList:c.filterList})}).then(async()=>{if(!u.dirty)return;await t.action("drawImage"),await y(100);const{promise:R,resolve:j}=v();return e.current.toBlob(b=>{if(!b)return j(void 0);URL.revokeObjectURL(a);const w=URL.createObjectURL(b);i(w),j(void 0)}),R}).finally(()=>{u.dirty=!1,l(!1)})},[a,t]);return{loading:p,imageUrl:a,error:d,compose:f}}const{useStore:Ae,useStoreSlice:k,getStore:Z}=I(e=>({fullback:L(),setFullback(r){e({fullback:r})}}));function ee(){const e=F(),r=n.useRef([]),t=n.useRef([]),a=n.useRef(null),{loading:i,imageUrl:p,error:l,compose:d}=X(),g=T(K,()=>{e(-1)});z(()=>{window.open(p)},[x.PREVIEW_IMAGE]);const f=n.useCallback(A(m=>{var h;r.current=m||(m=[]),d(m,{filterList:t.current,...(h=a.current)==null?void 0:h.getValue()})},500),[t,d]),o=n.useCallback(m=>{t.current=m,f()},[f]),c=n.useCallback(()=>{f()},[f]);return g?s.jsx(G,{onFirstAppear:()=>S.appear("tool-pht"),children:s.jsxs(W,{$flex:"1",$direction:"column",children:[s.jsx(B,{ref:a,onChange:c}),s.jsx(O,{onChange:o}),s.jsx(_,{onChange:f}),s.jsxs(M,{spinning:i,delay:100,size:"large",tip:"处理中...",children:[s.jsx(E,{when:p&&!l,children:()=>s.jsx(V,{src:p})}),s.jsx(E,{when:l,children:()=>s.jsx("span",{style:{color:"red"},children:l})})]})]})}):null}function Ue(){const{fullback:e}=k("fullback");return e?s.jsx(U,{}):s.jsx(ee,{})}function te(){const{fullback:e}=k("fullback");return s.jsx($,{buttons:[...e?[]:[{text:"降级",onClick:()=>Z().setFullback(!0)}],{text:"预览",hidden:L(),onClick(){q({id:"preview-image",type:x.PREVIEW_IMAGE})}}]})}const Te={title:"拼好图",needBackIcon:!0,rightArea:s.jsx(te,{})};export{Ue as Component,Te as handle};
