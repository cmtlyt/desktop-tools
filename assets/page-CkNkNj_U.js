const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/page-BmWYxxwi.js","assets/index-DcZ2pANc.js","assets/index-Dk2L6hWJ.css","assets/component-Dy0WxrvD.js","assets/button-Ch2TvbCU.js","assets/index-0kWlctU-.js","assets/asyncToGenerator-BcjGD0Qn.js","assets/reactNode-BNBQyY1s.js","assets/PurePanel-DkOr-iRc.js","assets/UnstableContext-yAUbyLg4.js","assets/compact-item-Z3TGKqzP.js","assets/LoadingOutlined-vQm4KgZI.js","assets/pickAttrs-CnoVZ5cH.js","assets/useLocale-Clf7rP0V.js","assets/BaseInput-A62ngUWK.js","assets/index-DwUFYxEz.js","assets/index-CzZvb85b.js","assets/DownOutlined-BJcyReC2.js","assets/index-kCCpzCeX.js","assets/index-BiBuMtNh.js","assets/index-S9R6XXnE.js","assets/fade-C2v5s6aI.js","assets/use-navigate-ghhqHgEc.js","assets/index-ChYcQMZ7.js","assets/index-Baf81WNP.js","assets/constant-Dqe_e0L0.js"])))=>i.map(i=>d[i]);
import{l as S,r as n,aQ as v,aH as P,aP as w,aR as I,m as H,a2 as A,j as s,E as _}from"./index-DcZ2pANc.js";import{u as U,W as T,C as W,I as O,U as B,S as V,P as F}from"./component-Dy0WxrvD.js";import{u as M}from"./use-navigate-ghhqHgEc.js";import{A as G}from"./index-ChYcQMZ7.js";import{B as $}from"./index-TbkfZ_aW.js";import{S as j}from"./index-Baf81WNP.js";import{P as z}from"./constant-Dqe_e0L0.js";import{S as D,c as K}from"./Subject-BZhSXr-W.js";import{i as L}from"./is-phone-Cc5-6_Jj.js";import"./button-Ch2TvbCU.js";import"./index-0kWlctU-.js";import"./asyncToGenerator-BcjGD0Qn.js";import"./reactNode-BNBQyY1s.js";import"./PurePanel-DkOr-iRc.js";import"./UnstableContext-yAUbyLg4.js";import"./compact-item-Z3TGKqzP.js";import"./LoadingOutlined-vQm4KgZI.js";import"./pickAttrs-CnoVZ5cH.js";import"./useLocale-Clf7rP0V.js";import"./BaseInput-A62ngUWK.js";import"./index-DwUFYxEz.js";import"./index-CzZvb85b.js";import"./DownOutlined-BJcyReC2.js";import"./index-kCCpzCeX.js";import"./index-BiBuMtNh.js";import"./index-S9R6XXnE.js";import"./fade-C2v5s6aI.js";import"./iconBase-B3nHQvqh.js";import"./index-B4g9YTQJ.js";import"./index-DwMrNhzC.js";var x=(e=>(e.PREVIEW_IMAGE="preview_image",e))(x||{});const k=new D;function N(e){var r;k.next(e),(r=e.ext)!=null&&r.disableAutoLogger||S.event("pht-action",e)}const Q=K(k);function q(e){return new Proxy({async action(r,t,a=[]){var d,g;const{promise:i,resolve:p}=v(),l=({data:{result:m}})=>{var o;p(m),(o=e.current)==null||o.removeEventListener("message",l)};return(d=e.current)==null||d.addEventListener("message",l),(g=e.current)==null||g.postMessage({action:r,option:t},a),i}},{get(r,t,a){if(t in r)return Reflect.get(r,t,a);const i=e.current[t];return typeof i=="function"?i.bind(e.current):i}})}function Y(e,r){const t=n.useRef(null),a=n.useMemo(()=>q(t),[]);return n.useEffect(()=>(t.current=new Worker(e,{type:"module"}),r==null||r(a),()=>{var i;(i=t.current)==null||i.terminate()}),[e]),a}const J=new URL("/desktop-tools/assets/compose-worker-DQclmwbB.ts",import.meta.url);function X(){const e=n.useRef(document.createElement("canvas")),r=n.useRef({dirty:!0,width:0,height:0,images:[],jitterRange:30,replaceColor:"#000000",filterList:[]}),t=Y(J,w(o=>{S.warn("如果需要调整本页面相关内容, 请先关闭 React 的严格渲染模式"),I(()=>{var f;const c=(f=e.current)==null?void 0:f.transferControlToOffscreen();!c||!o||o.action("init",{offscreen:c},[c])})})),[a,i]=n.useState(""),[p,l]=n.useState(!1),[d,g]=n.useState("");n.useEffect(()=>{const o=c=>{g(c.message),l(!1)};return t.addEventListener("error",o),()=>{t.removeEventListener("error",o)}},[t]);const m=n.useCallback(async(o,c={})=>{if(g(""),!e.current||!o.length){i("");return}const{replaceColor:f="#000000",jitterRange:h=30}=c;l(!0);const u=r.current;return Promise.resolve().then(()=>{if(!(u.images.toString()===o.toString()&&u.jitterRange===h&&u.replaceColor===f))return u.dirty=!0,u.images=o,u.jitterRange=h,t.action("compose",{imgs:o,options:c})}).then(()=>{var R;if(!(!u.dirty&&u.filterList.toString()===((R=c.filterList)==null?void 0:R.toString())))return u.dirty=!0,u.filterList=c.filterList||[],t.action("filter",{filterList:c.filterList})}).then(async()=>{if(!u.dirty)return;await t.action("drawImage"),await P(100);const{promise:R,resolve:E}=v();return e.current.toBlob(b=>{if(!b)return E(void 0);URL.revokeObjectURL(a);const y=URL.createObjectURL(b);i(y),E(void 0)}),R}).finally(()=>{u.dirty=!1,l(!1)})},[a,t]);return{loading:p,imageUrl:a,error:d,compose:m}}const{useStore:_e,useStoreSlice:C,getStore:Z}=H(e=>({fullback:L(),setFullback(r){e({fullback:r})}})),ee=n.lazy(()=>A(()=>import("./page-BmWYxxwi.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25])));function te(){const e=M(),r=n.useRef([]),t=n.useRef([]),a=n.useRef(null),{loading:i,imageUrl:p,error:l,compose:d}=X(),g=U(z,()=>{e(-1)});Q(()=>{window.open(p)},[x.PREVIEW_IMAGE]);const m=n.useCallback(_(f=>{var h;r.current=f||(f=[]),d(f,{filterList:t.current,...(h=a.current)==null?void 0:h.getValue()})},500),[t,d]),o=n.useCallback(f=>{t.current=f,m()},[m]),c=n.useCallback(()=>{m()},[m]);return g?s.jsx(G,{onFirstAppear:()=>S.appear("tool-pht"),children:s.jsxs(T,{$flex:"1",$direction:"column",children:[s.jsx(W,{ref:a,onChange:c}),s.jsx(O,{onChange:o}),s.jsx(B,{onChange:m}),s.jsxs(V,{spinning:i,delay:100,size:"large",tip:"处理中...",children:[s.jsx(j,{when:p&&!l,children:()=>s.jsx(F,{src:p})}),s.jsx(j,{when:l,children:()=>s.jsx("span",{style:{color:"red"},children:l})})]})]})}):null}function Ue(){const{fullback:e}=C("fullback");return e?s.jsx(ee,{}):s.jsx(te,{})}function re(){const{fullback:e}=C("fullback");return s.jsx($,{buttons:[...e?[]:[{text:"降级",onClick:()=>Z().setFullback(!0)}],{text:"预览",hidden:L(),onClick(){N({id:"preview-image",type:x.PREVIEW_IMAGE})}}]})}const Te={title:"拼好图",needBackIcon:!0,rightArea:s.jsx(re,{})};export{Ue as Component,Te as handle};
