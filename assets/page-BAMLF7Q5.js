import{l as S,r as n,aH as v,aT as I,aU as w,aV as y,aJ as A,n as P,j as t,G as H}from"./index-DwZ3VcdL.js";import{u as U}from"./use-navigate-C5nXX1Gc.js";import{C as T,u as W,W as O,a as V,I as _,S as B,P as G}from"./page-Bhsyv_PN.js";import{A as F}from"./index-D7gmBVc6.js";import{S as C}from"./index-Baf81WNP.js";import{I as M}from"./index-Bagtf7U1.js";import{R as $}from"./index-CGks_N0C.js";import{P as K}from"./constant-Dqe_e0L0.js";import{c as Y,S as q}from"./Subject-Nip3sQUI.js";import{u as z}from"./use-web-worker-CrXNPIIT.js";import{i as J}from"./is-phone-yIPvuEgq.js";import"./button-BxUGn_cn.js";import"./index-te4-RsG4.js";import"./asyncToGenerator-B1e0bwTg.js";import"./reactNode-B9hRVRxn.js";import"./PurePanel-DPtUqUj9.js";import"./UnstableContext-Ctka8GEx.js";import"./compact-item-IKBUWjwX.js";import"./LoadingOutlined-LsngurYf.js";import"./pickAttrs-CZcRfMez.js";import"./useLocale-CE8QlpIE.js";import"./useVariants-PCdYoXqz.js";import"./index-BkSxskOT.js";import"./index-Bcuwydoc.js";import"./useForceUpdate-DqwNPTIk.js";import"./EyeOutlined-CNjMdUWL.js";import"./index-2zJKJxb2.js";import"./BaseInput-Yhc0NpJS.js";import"./Input-DQokMNph.js";import"./index-D2i9Awo8.js";import"./fade-DBHzhfQ-.js";import"./index-BS5FmYRV.js";import"./index-Rcsh-DYt.js";import"./iconBase-BFWPPRPh.js";import"./index-B4g9YTQJ.js";import"./index-cB1IlPo3.js";var j=(e=>(e.PREVIEW_IMAGE="preview_image",e))(j||{});const k=new q;function N(e){var c;k.next(e),(c=e.ext)!=null&&c.disableAutoLogger||S.event("pht-action",e)}const D=Y(k),Q="/desktop-tools/assets/compose-worker-B-Ml9q49.js";function X(){const e=n.useRef(document.createElement("canvas")),c=n.useRef({dirty:!0,width:0,height:0,images:[],jitterRange:30,replaceColor:"#000000",filterList:[]}),i=z(Q,w(s=>{S.warn("如果需要调整本页面相关内容, 请先关闭 React 的严格渲染模式"),y(()=>{var a;const r=(a=e.current)==null?void 0:a.transferControlToOffscreen();!r||!s||s.action("init",{offscreen:r},[r])},A)})),[p,d]=n.useState(""),[m,l]=n.useState(!1),[g,h]=n.useState("");n.useEffect(()=>{const s=r=>{h(r.message),l(!1)};return i.addEventListener("error",s),()=>{i.removeEventListener("error",s)}},[i]);const u=n.useCallback(async(s,r={})=>{if(h(""),!e.current||!s.length){d("");return}const{replaceColor:a="#000000",jitterRange:f=30}=r;l(!0);const o=c.current;return Promise.resolve().then(()=>{if(!(o.images.toString()===s.toString()&&o.jitterRange===f&&o.replaceColor===a))return o.dirty=!0,o.images=s,o.jitterRange=f,o.replaceColor=a,i.action("compose",{imgs:s,options:r})}).then(()=>{var R;if(!(!o.dirty&&o.filterList.toString()===((R=r.filterList)==null?void 0:R.toString())))return o.dirty=!0,o.filterList=r.filterList||[],i.action("filter",{filterList:r.filterList})}).then(async()=>{if(!o.dirty)return;await i.action("drawImage"),await v(100);const{promise:R,resolve:x}=I();return e.current.toBlob(b=>{if(!b)return x(void 0);URL.revokeObjectURL(p);const E=URL.createObjectURL(b);d(E),x(void 0)}),R}).finally(()=>{o.dirty=!1,l(!1)})},[p,i]);return{loading:m,imageUrl:p,error:g,compose:u}}const{useStoreSlice:L,getStore:Z}=P(e=>({fullback:!1,setFullback(c){e({fullback:c})}}));function ee(){const e=U(),c=n.useRef([]),i=n.useRef([]),p=n.useRef(null),{loading:d,imageUrl:m,error:l,compose:g}=X(),h=W(K,()=>{e(-1)});D(()=>{window.open(m)},[j.PREVIEW_IMAGE]);const u=n.useCallback(H(a=>{var f;c.current=a||(a=c.current),g(a,{filterList:i.current,...(f=p.current)==null?void 0:f.getValue()})},500),[g]),s=n.useCallback(a=>{i.current=a,u()},[u]),r=n.useCallback(()=>{u()},[u]);return h?t.jsx(F,{onFirstAppear:()=>S.appear("tool-pht"),children:t.jsxs(O,{$flex:"1",$direction:"column",children:[t.jsx(V,{ref:p,onChange:r}),t.jsx(_,{onChange:s}),t.jsx(M,{onChange:u}),t.jsxs(B,{spinning:d,delay:100,size:"large",tip:"处理中...",children:[t.jsx(C,{when:m&&!l,children:()=>t.jsx(G,{src:m})}),t.jsx(C,{when:l,children:()=>t.jsx("span",{style:{color:"red"},children:l})})]})]})}):null}function _e(){const{fullback:e}=L("fullback");return e?t.jsx(T,{}):t.jsx(ee,{})}function te(){const{fullback:e}=L("fullback");return t.jsx($,{buttons:[...e?[]:[{text:"降级",onClick:()=>Z().setFullback(!0)}],{text:"预览",hidden:J(),onClick(){N({id:"preview-image",type:j.PREVIEW_IMAGE})}}]})}const Be={title:"拼好图",needBackIcon:!0,rightArea:t.jsx(te,{})};export{_e as Component,Be as handle};
