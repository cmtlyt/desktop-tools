import{l as S,r as n,aR as E,aJ as w,aS as I,aT as P,n as A,j as s,G as H}from"./index-DT0B52yf.js";import{C as U,u as T,W,a as B,I as O,U as _,S as F,P as G}from"./page-ecmUNETP.js";import{u as M}from"./use-navigate-GpfY3OJS.js";import{A as V}from"./index-Czdnd5LA.js";import{B as $}from"./index-BWusZM_t.js";import{S as v}from"./index-Baf81WNP.js";import{P as K}from"./constant-Dqe_e0L0.js";import{c as N,S as q}from"./Subject-D1wgtsOM.js";import{i as C}from"./is-phone-C2UcZsrP.js";import"./button-CWWA2bgJ.js";import"./index-DQ63XqXT.js";import"./asyncToGenerator-BTKhQiEB.js";import"./reactNode-BtANdkVz.js";import"./PurePanel-Pfgz3KHx.js";import"./UnstableContext-DmnG8ZOI.js";import"./compact-item-C95n7eyH.js";import"./LoadingOutlined--LbHTeuI.js";import"./pickAttrs-BOmny2Mq.js";import"./useLocale-BJBYmu_7.js";import"./BaseInput-BAuMCPOY.js";import"./index-CHyH1U9y.js";import"./index-Cl6iKZPc.js";import"./useForceUpdate-CGjf6npd.js";import"./EyeOutlined-CMMDe74N.js";import"./index-BS3YxJ4_.js";import"./fade-0ItItjBx.js";import"./index-DBCh23kB.js";import"./iconBase-DC6UpTJX.js";import"./index-B4g9YTQJ.js";import"./index-Dneh6lcx.js";var j=(e=>(e.PREVIEW_IMAGE="preview_image",e))(j||{});const L=new q;function z(e){var r;L.next(e),(r=e.ext)!=null&&r.disableAutoLogger||S.event("pht-action",e)}const J=N(L);function Y(e){return new Proxy({async action(r,t,a=[]){var d,g;const{promise:i,resolve:p}=E(),l=({data:{result:m}})=>{var o;p(m),(o=e.current)==null||o.removeEventListener("message",l)};return(d=e.current)==null||d.addEventListener("message",l),(g=e.current)==null||g.postMessage({action:r,option:t},a),i}},{get(r,t,a){if(t in r)return Reflect.get(r,t,a);const i=e.current[t];return typeof i=="function"?i.bind(e.current):i}})}function D(e,r){const t=n.useRef(null),a=n.useMemo(()=>Y(t),[]);return n.useEffect(()=>(t.current=new Worker(e,{type:"module"}),r==null||r(a),()=>{var i;(i=t.current)==null||i.terminate()}),[e]),a}const Q="/desktop-tools/assets/compose-worker-BSRs1k8F.js";function X(){const e=n.useRef(document.createElement("canvas")),r=n.useRef({dirty:!0,width:0,height:0,images:[],jitterRange:30,replaceColor:"#000000",filterList:[]}),t=D(Q,I(o=>{S.warn("如果需要调整本页面相关内容, 请先关闭 React 的严格渲染模式"),P(()=>{var f;const c=(f=e.current)==null?void 0:f.transferControlToOffscreen();!c||!o||o.action("init",{offscreen:c},[c])})})),[a,i]=n.useState(""),[p,l]=n.useState(!1),[d,g]=n.useState("");n.useEffect(()=>{const o=c=>{g(c.message),l(!1)};return t.addEventListener("error",o),()=>{t.removeEventListener("error",o)}},[t]);const m=n.useCallback(async(o,c={})=>{if(g(""),!e.current||!o.length){i("");return}const{replaceColor:f="#000000",jitterRange:h=30}=c;l(!0);const u=r.current;return Promise.resolve().then(()=>{if(!(u.images.toString()===o.toString()&&u.jitterRange===h&&u.replaceColor===f))return u.dirty=!0,u.images=o,u.jitterRange=h,u.replaceColor=f,t.action("compose",{imgs:o,options:c})}).then(()=>{var R;if(!(!u.dirty&&u.filterList.toString()===((R=c.filterList)==null?void 0:R.toString())))return u.dirty=!0,u.filterList=c.filterList||[],t.action("filter",{filterList:c.filterList})}).then(async()=>{if(!u.dirty)return;await t.action("drawImage"),await w(100);const{promise:R,resolve:x}=E();return e.current.toBlob(b=>{if(!b)return x(void 0);URL.revokeObjectURL(a);const y=URL.createObjectURL(b);i(y),x(void 0)}),R}).finally(()=>{u.dirty=!1,l(!1)})},[a,t]);return{loading:p,imageUrl:a,error:d,compose:m}}const{useStoreSlice:k,getStore:Z}=A(e=>({fullback:C(),setFullback(r){e({fullback:r})}}));function ee(){const e=M(),r=n.useRef([]),t=n.useRef([]),a=n.useRef(null),{loading:i,imageUrl:p,error:l,compose:d}=X(),g=T(K,()=>{e(-1)});J(()=>{window.open(p)},[j.PREVIEW_IMAGE]);const m=n.useCallback(H(f=>{var h;r.current=f||(f=r.current),d(f,{filterList:t.current,...(h=a.current)==null?void 0:h.getValue()})},500),[t,d]),o=n.useCallback(f=>{t.current=f,m()},[m]),c=n.useCallback(()=>{m()},[m]);return g?s.jsx(V,{onFirstAppear:()=>S.appear("tool-pht"),children:s.jsxs(W,{$flex:"1",$direction:"column",children:[s.jsx(B,{ref:a,onChange:c}),s.jsx(O,{onChange:o}),s.jsx(_,{onChange:m}),s.jsxs(F,{spinning:i,delay:100,size:"large",tip:"处理中...",children:[s.jsx(v,{when:p&&!l,children:()=>s.jsx(G,{src:p})}),s.jsx(v,{when:l,children:()=>s.jsx("span",{style:{color:"red"},children:l})})]})]})}):null}function He(){const{fullback:e}=k("fullback");return e?s.jsx(U,{}):s.jsx(ee,{})}function te(){const{fullback:e}=k("fullback");return s.jsx($,{buttons:[...e?[]:[{text:"降级",onClick:()=>Z().setFullback(!0)}],{text:"预览",hidden:C(),onClick(){z({id:"preview-image",type:j.PREVIEW_IMAGE})}}]})}const Ue={title:"拼好图",needBackIcon:!0,rightArea:s.jsx(te,{})};export{He as Component,Ue as handle};
