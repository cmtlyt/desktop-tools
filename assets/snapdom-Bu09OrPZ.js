var N=new Map,A=new Map,L=new Map,$=new Map,U=new Map,D=new WeakMap;function X(t){if($.has(t))return $.get(t);if(new Set(["script","style","meta","link","noscript","template"]).has(t)){const i={};return $.set(t,i),i}let a=document.getElementById("snapdom-sandbox");a||(a=document.createElement("div"),a.id="snapdom-sandbox",a.style.position="absolute",a.style.left="-9999px",a.style.top="-9999px",a.style.width="0",a.style.height="0",a.style.overflow="hidden",document.body.appendChild(a));const n=document.createElement(t);n.style.all="initial",a.appendChild(n);const s=getComputedStyle(n),o={};for(let i of s)o[i]=s.getPropertyValue(i);return a.removeChild(n),$.set(t,o),o}function O(t,e,a=!1){const n=[],s=X(e);for(let[o,i]of Object.entries(t))if(!a)i&&n.push(`${o}:${i}`);else{const d=s[o];i&&i!==d&&n.push(`${o}:${i}`)}return n.sort().join(";")}function K(t){const e=new Set;return t.nodeType!==Node.ELEMENT_NODE&&t.nodeType!==Node.DOCUMENT_FRAGMENT_NODE?[]:(t.tagName&&e.add(t.tagName.toLowerCase()),typeof t.querySelectorAll=="function"&&t.querySelectorAll("*").forEach(a=>e.add(a.tagName.toLowerCase())),Array.from(e))}function G(t){const e=new Map;for(let n of t){const s=$.get(n);if(!s)continue;const o=Object.entries(s).map(([i,d])=>`${i}:${d};`).sort().join("");e.has(o)||e.set(o,[]),e.get(o).push(n)}let a="";for(let[n,s]of e.entries())a+=`${s.join(",")} { ${n} }
`;return a}function Q(t){const e=new Set(t.values()),a=new Map;let n=1;for(const s of e)a.set(s,`c${n++}`);return a}function S(t,{fast:e=!1}={}){if(e)return t();"requestIdleCallback"in window?requestIdleCallback(t,{timeout:50}):setTimeout(t,1)}function F(t,e=null){if(!(t instanceof Element))return window.getComputedStyle(t,e);let a=D.get(t);if(a||(a=new Map,D.set(t,a)),!a.has(e)){const n=window.getComputedStyle(t,e);a.set(e,n)}return a.get(e)}function Z(t){let e=t.replace(/^['"]|['"]$/g,"");if(e.startsWith("\\"))try{return String.fromCharCode(parseInt(e.replace("\\",""),16))}catch{return e}return e}function T(t){const e=t.indexOf("url(");if(e===-1)return null;let a=t.slice(e+4).trim();return a.endsWith(")")&&(a=a.slice(0,-1).trim()),(a.startsWith('"')&&a.endsWith('"')||a.startsWith("'")&&a.endsWith("'"))&&(a=a.slice(1,-1)),a}function P(t){return[/font\s*awesome/i,/material\s*icons/i,/ionicons/i,/glyphicons/i,/feather/i,/bootstrap\s*icons/i,/remix\s*icons/i,/heroicons/i].some(a=>a.test(t))}function R(t,e=3e3){return N.has(t)?Promise.resolve(N.get(t)):new Promise((a,n)=>{const s=setTimeout(()=>{n(new Error("Image load timed out"))},e),o=new Image;o.crossOrigin="anonymous",o.onload=async()=>{clearTimeout(s);try{await o.decode();const i=document.createElement("canvas");i.width=o.width,i.height=o.height,i.getContext("2d").drawImage(o,0,0,i.width,i.height);try{const c=i.toDataURL("image/png");N.set(t,c),a(c)}catch{n(new Error("CORS restrictions prevented image capture"))}}catch(i){n(i)}},o.onerror=i=>{clearTimeout(s),n(new Error("Failed to load image: "+(i.message||"Unknown error")))},o.src=t})}function W(t){const e={};for(let a of t)e[a]=t.getPropertyValue(a);return e}function V(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function j(t,e,a,n,s){var r;if(t.tagName==="STYLE")return;n.has(t)||n.set(t,F(t));const o=n.get(t),i=W(o),d=((r=t.tagName)==null?void 0:r.toLowerCase())||"div",c=O(i,d,s);a.set(e,c)}function B(t,e,a,n,s){var d;if(t.nodeType===Node.ELEMENT_NODE&&t.getAttribute("data-capture")==="exclude"){const c=document.createElement("div"),r=t.getBoundingClientRect();return c.style.cssText=`display: inline-block; width: ${r.width}px; height: ${r.height}px; visibility: hidden;`,c}if(t.tagName==="IFRAME"){const c=document.createElement("div");return c.textContent="",c.style.cssText=`width: ${t.offsetWidth}px; height: ${t.offsetHeight}px; background: repeating-linear-gradient(45deg, #ddd, #ddd 5px, #f9f9f9 5px, #f9f9f9 10px);display: flex;align-items: center;justify-content: center;font-size: 12px;color: #555; border: 1px solid #aaa;`,c}if(t.nodeType===Node.ELEMENT_NODE&&t.getAttribute("data-capture")==="placeholder"){const c=t.cloneNode(!1);n.set(c,t),j(t,c,e,a,s);const r=document.createElement("div");return r.textContent=t.getAttribute("data-placeholder-text")||"",r.style.cssText="color: #666;font-size: 12px;text-align: center;line-height: 1.4;padding: 0.5em;box-sizing: border-box;",c.appendChild(r),c}if(t.tagName==="CANVAS"){const c=t.toDataURL(),r=document.createElement("img");return r.src=c,r.width=t.width,r.height=t.height,r.style.display="inline-block",r.style.width=`${t.width}px`,r.style.height=`${t.height}px`,r}if(t.nodeType===Node.TEXT_NODE){if((d=t.parentElement)!=null&&d.shadowRoot){const c=t.parentElement.tagName.toLowerCase();if(customElements.get(c))return null}return t.cloneNode(!0)}if(t.nodeType!==Node.ELEMENT_NODE)return t.cloneNode(!0);const o=t.cloneNode(!1);n.set(o,t),t instanceof HTMLInputElement?(o.value=t.value,o.setAttribute("value",t.value),t.checked!==void 0&&(o.checked=t.checked,t.checked&&o.setAttribute("checked",""))):t instanceof HTMLTextAreaElement?(o.value=t.value,o.textContent=t.value):t instanceof HTMLSelectElement&&(o.value=t.value,Array.from(o.options).forEach(c=>{c.value===t.value?c.setAttribute("selected",""):c.removeAttribute("selected")})),j(t,o,e,a,s);const i=document.createDocumentFragment();if(t.childNodes.forEach(c=>{const r=B(c,e,a,n,s);r&&i.appendChild(r)}),o.appendChild(i),t.shadowRoot){const c=Array.from(t.shadowRoot.children).filter(l=>l.tagName!=="STYLE").map(l=>B(l,e,a,n)).filter(Boolean),r=document.createDocumentFragment();c.forEach(l=>r.appendChild(l)),o.appendChild(r)}return o}async function tt(t,e,a,n=32,s="#000"){e=e.replace(/^['"]+|['"]+$/g,"");const o=window.devicePixelRatio||1,d=document.createElement("canvas").getContext("2d");d.font=a?`${a} ${n}px "${e}"`:`${n}px "${e}"`;const c=d.measureText(t),r=c.actualBoundingBoxAscent||n*.8,l=c.actualBoundingBoxDescent||n*.2,h=r+l,u=c.width,g=document.createElement("canvas");g.width=Math.ceil(u*o),g.height=Math.ceil(h*o);const f=g.getContext("2d");return f.scale(o,o),f.font=d.font,f.textAlign="left",f.textBaseline="alphabetic",f.fillStyle=s,f.fillText(t,0,r),g.toDataURL()}async function et({ignoreIconFonts:t=!0,preCached:e=!1}){const a=Array.from(document.querySelectorAll('link[rel="stylesheet"]')).filter(s=>s.href);let n="";for(const s of a)try{const i=await(await fetch(s.href)).text();if(t&&(P(s.href)||P(i)))continue;const d=/url\(([^)]+)\)/g,c=await Promise.all(Array.from(i.matchAll(d)).map(async l=>{let h=T(l[0]);if(!h)return null;let u=h;u.startsWith("http")||(u=new URL(u,s.href).href);try{u=encodeURI(u)}catch{console.warn("[snapdom] Failed to encode font URL:",u)}if(t&&P(u))return null;if(L.has(u))return{original:l[0],inlined:`url(${L.get(u)})`};try{const f=await(await fetch(u)).blob(),w=await new Promise(x=>{const v=new FileReader;v.onload=()=>x(v.result),v.readAsDataURL(f)});return L.set(u,w),{original:l[0],inlined:`url(${w})`}}catch{return console.warn("❌ Failed to fetch font:",u),null}}));let r=i;for(const l of c)l&&(r=r.replace(l.original,l.inlined));n+=r+`
`}catch{console.warn("❌ Failed to fetch CSS:",s.href)}if(n&&e){const s=document.createElement("style");s.setAttribute("data-snapdom","embedFonts"),s.textContent=n,document.head.appendChild(s)}return n}async function H(t,e,a,n,s,o=!1){if(!(t instanceof Element)||!(e instanceof Element))return;for(const c of["::before","::after"])try{const r=F(t,c);if(!r)continue;const l=r.getPropertyValue("content"),h=r.getPropertyValue("background-image"),u=l&&l!=="none"&&l!=='""'&&l!=="''",g=h&&h.startsWith("url(");if(u||g){const f=r.getPropertyValue("font-family"),w=parseInt(r.getPropertyValue("font-size"))||32,x=parseInt(r.getPropertyValue("font-weight"))||!1,v=r.getPropertyValue("color")||"#000",m=document.createElement("span");m.dataset.snapdomPseudo=c;const E=W(r),k=O(E,"span",s);a.set(m,k);const I=f&&/font.*awesome|material|bootstrap|glyphicons|ionicons|remixicon|simple-line-icons|octicons|feather|typicons|weathericons/i.test(f);let b=Z(l);if(!o&&I&&b.length===1){const y=document.createElement("img");y.src=await tt(b,f,x,w,v),y.style="display:block;width:100%;height:100%;object-fit:contain;",m.appendChild(y)}else if(b.startsWith("url(")){const y=T(b);if(y)try{const C=document.createElement("img"),J=await R(encodeURI(y));C.src=J,C.style="display:block;width:100%;height:100%;object-fit:contain;",m.appendChild(C)}catch(C){console.error(`[snapdom] Error in pseudo ${c} for`,t,C)}}else!I&&b&&b!=="none"&&(m.textContent=b);if(g&&h){const y=T(h);if(y)try{const C=await R(encodeURI(y));m.style.backgroundImage=`url(${C})`}catch(C){console.warn(`[snapdom] Failed to inline background-image for ${c}`,C)}}if(!(m.childNodes.length>0||m.textContent&&m.textContent.trim()!=="")&&!g)continue;c==="::before"?e.insertBefore(m,e.firstChild):e.appendChild(m)}}catch(r){console.warn(`[snapdom] Failed to capture ${c} for`,t,r)}const i=Array.from(t.children),d=Array.from(e.children).filter(c=>!c.dataset.snapdomPseudo);for(let c=0;c<Math.min(i.length,d.length);c++)await H(i[c],d[c],a,n,s,o)}async function nt(t,e=!1,a=!1){var c;const n=new Map,s=new WeakMap,o=new Map;let i;try{i=B(t,n,s,o,e)}catch(r){throw console.warn("deepClone failed:",r),r}try{await H(t,i,n,s,e,a)}catch(r){console.warn("inlinePseudoElements failed:",r)}let d="";if(e){const r=Q(n);d=Array.from(r.entries()).map(([l,h])=>`.${h}{${l}}`).join("");for(const[l,h]of n.entries()){if(l.tagName==="STYLE")continue;const u=r.get(h);u&&l.classList.add(u);const g=(c=l.style)==null?void 0:c.backgroundImage;l.removeAttribute("style"),g&&g!=="none"&&(l.style.backgroundImage=g)}}else for(const[r,l]of n.entries())r.tagName!=="STYLE"&&r.setAttribute("style",l.replace(/;/g,"; "));for(const[r,l]of o.entries()){const h=l.scrollLeft,u=l.scrollTop;if((h||u)&&r instanceof HTMLElement){r.style.overflow="hidden",r.style.scrollbarWidth="none",r.style.msOverflowStyle="none";const f=document.createElement("div");for(f.style.transform=`translate(${-h}px, ${-u}px)`,f.style.willChange="transform",f.style.display="inline-block",f.style.width="100%";r.firstChild;)f.appendChild(r.firstChild);r.appendChild(f)}}return{clone:i,classCSS:d,styleCache:s}}async function at(t){const e=Array.from(t.querySelectorAll("img")),a=async n=>{const s=n.src;try{const o=await R(s);n.src=o,n.width||(n.width=n.naturalWidth||100),n.height||(n.height=n.naturalHeight||100)}catch{const o=document.createElement("div");o.style=`width: ${n.width||100}px; height: ${n.height||100}px; background: #ccc; display: inline-block; text-align: center; line-height: ${n.height||100}px; color: #666; font-size: 12px;`,o.innerText="img",n.replaceWith(o)}};for(let n=0;n<e.length;n+=4){const s=e.slice(n,n+4).map(a);await Promise.allSettled(s)}}async function ot(t,e,a){const n=[[t,e]];for(;n.length;){const[s,o]=n.shift(),i=a.get(s)||F(s);a.has(s)||a.set(s,i);const d=i.getPropertyValue("background-image"),c=T(d);if(c)try{let h=encodeURI(c),u;A.has(h)?u=A.get(h):(u=await R(h),A.set(h,u)),o.style.backgroundImage=`url(${u})`}catch{o.style.backgroundImage="none"}const r=Array.from(s.children),l=Array.from(o.children);for(let h=0;h<Math.min(r.length,l.length);h++)n.push([r[h],l[h]])}}async function st(t,e={}){if(!t)throw new Error("Element cannot be null or undefined");const{compress:a=!0,embedFonts:n=!1,fast:s=!0,scale:o=1}=e;let i,d,c,r="",l="",h,u;if({clone:i,classCSS:d,styleCache:c}=await nt(t,a,n),await new Promise(f=>{S(async()=>{await at(i),f()},{fast:s})}),await new Promise(f=>{S(async()=>{await ot(t,i,c),f()},{fast:s})}),n&&await new Promise(f=>{S(async()=>{r=await et({ignoreIconFonts:!n}),f()},{fast:s})}),a){const f=K(i).sort(),w=f.join(",");U.has(w)?l=U.get(w):await new Promise(x=>{S(()=>{l=G(f),U.set(w,l),x()},{fast:s})})}await new Promise(f=>{S(()=>{const w=t.getBoundingClientRect(),x=Math.ceil(w.width),v=Math.ceil(w.height);i.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),i.style.transformOrigin="top left",o!==1&&V()&&(i.style.scale=`${o}`);const m="http://www.w3.org/2000/svg",E=document.createElementNS(m,"foreignObject");E.setAttribute("width","100%"),E.setAttribute("height","100%");const k=document.createElement("style");k.textContent=l+r+"svg{overflow:visible;}"+d,E.appendChild(k),E.appendChild(i);const b=new XMLSerializer().serializeToString(E);u=`<svg xmlns="${m}" width="${x}" height="${v}" viewBox="0 0 ${x} ${v}">`+b+"</svg>",h=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(u)}`,f()},{fast:s})});const g=document.getElementById("snapdom-sandbox");return g&&g.style.position==="absolute"&&g.remove(),h}async function it(t,{dpr:e=1,scale:a=1}){const n=new Image;return n.src=t,await n.decode(),V?(n.width=n.width*a,n.height=n.height*a):(n.width=n.width/a,n.height=n.height/a),n}async function q(t,{dpr:e=1,scale:a=1}={}){const n=new Image;n.src=t,await n.decode();const s=document.createElement("canvas"),o=n.width*a,i=n.height*a;s.width=Math.ceil(o*e),s.height=Math.ceil(i*e);const d=s.getContext("2d");return d.scale(e,e),d.drawImage(n,0,0,o,i),s.style.width=`${o}px`,s.style.height=`${i}px`,s}async function z(t){const e=decodeURIComponent(t.split(",")[1]);return new Blob([e],{type:"image/svg+xml"})}async function _(t,{dpr:e=1,scale:a=1},n){const s=await q(t,{dpr:e,scale:a});if(!n)return s;const o=document.createElement("canvas");o.width=s.width,o.height=s.height;const i=o.getContext("2d");return i.fillStyle=n,i.fillRect(0,0,o.width,o.height),i.drawImage(s,0,0),o}async function M(t,{dpr:e=1,scale:a=1,backgroundColor:n="#fff",quality:s},o="png"){const i=await _(t,{dpr:e,scale:a},n),d=new Image;return d.src=i.toDataURL(`image/${o}`,s),await d.decode(),d.style.width=`${i.width/e}px`,d.style.height=`${i.height/e}px`,d}async function rt(t,{dpr:e=1,scale:a=1,backgroundColor:n="#fff",format:s="png",filename:o="capture"}={}){if(s==="svg"){const u=await z(t),g=URL.createObjectURL(u),f=document.createElement("a");f.href=g,f.download=`${o}.svg`,f.click(),URL.revokeObjectURL(g);return}const i=["jpg","jpeg","webp"].includes(s)?"#fff":void 0,c=await _(t,{dpr:e,scale:a},n??i),r={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",webp:"image/webp"}[s]||"image/png",l=c.toDataURL(r),h=document.createElement("a");h.href=l,h.download=`${o}.${s}`,h.click()}async function p(t,e={}){if(e={scale:1,...e},!t)throw new Error("Element cannot be null or undefined");return await p.capture(t,e)}p.capture=async(t,e={})=>{const a=await st(t,e),n=window.devicePixelRatio||1,s=e.scale||1;return{url:a,options:e,toRaw:()=>a,toImg:()=>it(a,{dpr:n,scale:s}),toCanvas:()=>q(a,{dpr:n,scale:s}),toBlob:()=>z(a),toPng:o=>M(a,{dpr:n,scale:s,...o},"png"),toJpg:o=>M(a,{dpr:n,scale:s,...o},"jpeg"),toWebp:o=>M(a,{dpr:n,scale:s,...o},"webp"),download:({format:o="png",filename:i="capture",backgroundColor:d}={})=>rt(a,{dpr:n,scale:s,backgroundColor:d,format:o,filename:i})}};p.toRaw=async(t,e)=>(await p.capture(t,e)).toRaw();p.toImg=async(t,e)=>(await p.capture(t,e)).toImg();p.toCanvas=async(t,e)=>(await p.capture(t,e)).toCanvas();p.toBlob=async(t,e)=>(await p.capture(t,e)).toBlob();p.toPng=async(t,e)=>(await p.capture(t,e)).toPng(e);p.toJpg=async(t,e)=>(await p.capture(t,e)).toJpg(e);p.toWebp=async(t,e)=>(await p.capture(t,e)).toWebp(e);p.download=async(t,e={})=>{const{format:a="png",filename:n="capture",backgroundColor:s,...o}=e;return await(await p.capture(t,o)).download({format:a,filename:n,backgroundColor:s})};export{p as snapdom};
