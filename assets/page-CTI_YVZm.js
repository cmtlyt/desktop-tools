import{r as l,x as g}from"./index-jyCDBXP7.js";import{i as ee,C as P,j as te,l as C,d as $,c as L,b as A,D as re,E as ne,g as oe,H as se,A as ae,a as ce,F as B}from"./index-DNgY6zfM.js";import{B as ue}from"./index-DdYnPdQb.js";import{S as ie,c as le}from"./create-action-subscribe-hook-xDtE27yb.js";import{E as me}from"./constant-DnvxCFPa.js";import"./index-COoaQ8Z_.js";const H=["0/15/0/0","2/2/3","3/3","3/6/0","6/3/0","0/7/2","2/2/6"];function fe(e,t){return n=>new Array(n?e:t).fill(0)}function k(e,t,n){return t.map((o,s)=>o|n[s+e])}function G(e){const t=Math.floor(Math.random()*H.length),n=H[t].split("/"),o=n.length,s=Math.floor((e-o)/2),i=n.map(r=>parseInt(r,10));return{size:o,elementData:i,rightSpace:s,topPos:0,width:V(i)}}function ge(e,t,n){return(o,s,i)=>{const r=[...i];switch(o){case"left":{if(r.some((c,a)=>{const m=s[a-n];return m&&m&c<<1?!0:c&1<<e-1}))break;return r.map(c=>c<<1)}case"right":{if(r.some((c,a)=>{const m=s[a-n];return m&&m&c>>1?!0:c&1}))break;return r.map(c=>c>>1)}case"bottom":{const c=r.slice(2).some((m,h)=>s[h+1]&m),a=r[t-1];if(c||a)throw{custom:!0,action:"submit"};r.unshift(0),r.pop();break}default:return r}return r}}function pe(e,t){return t.map(n=>n.toString(2).padStart(e,"0").split(""))}function V(e){return Math.max(...e.map(t=>t.toString(2).replace(/(^0+)|(0+$)/g,"").length))}function K(e,t){const{elementData:n,rightSpace:o,topPos:s,width:i}=t;let r=o;return r-i/2<0?r=0:r+i>e&&(r=e-i),t.rightSpace=r,new Array(s).fill(0).concat(n.map(c=>c<<r))}function z(e){const{size:t,elementData:n}=e,o=pe(t,n),s=Array.from({length:o.length},()=>new Array(o.length));for(let r=0;r<o.length;++r){const c=o[r];for(let a=0;a<c.length;++a)s[t-1-a][r]=o[r][a]}const i=s.map(r=>parseInt(r.join(""),2));return{...e,elementData:i,width:V(i)}}function de(e,t,n){const o=[];for(let s=0;s<e;++s)t[s]===n&&o.push(s);return o}function he(e,t){return e.toString(2).padStart(t).split("")}function U(e,t){l.useEffect(()=>(window.addEventListener(e,t),()=>window.removeEventListener(e,t)),[e,t])}var p=(e=>(e.running="running",e.pause="pause",e.over="over",e))(p||{});const Y=ee(e=>({gameId:P(),row:20,col:10,moveAddRow:2,gameStatus:"over",setRow:t=>e({row:t}),setCol:t=>e({col:t}),setMoveAddRow:t=>e({moveAddRow:t}),updateGameId:()=>e({gameId:P(),gameStatus:"over"}),setGameStatus:t=>e({gameStatus:t})})),I=e=>Y(te(e)),x=()=>Y.getState();var d=(e=>(e.RELOAD_HISTORY="reload_history",e.START="start",e.PAUSE="pause",e.RELOAD="reload",e))(d||{});const W=new ie;function y(e){W.next(e),C.event("ELSFK-action",e)}const Se=le(W),J=$(A)`
  width: 40vh;
  height: 80vh;
  color: var(--color-primary);
`,we=$(J)`
  width: 15vmin;
  height: 15vmin;
`,xe=$.div`
  flex: 1;
  color: ${e=>e.$active?"inherit":"#0002"};
  box-shadow:
    inset 0 0 0 0.2rem currentColor,
    inset 0 0 0 0.8rem #fff ${e=>e.$active?", inset 0 0 0 10rem currentColor":""};
`,Re=$.span`
  font-size: 2rem;
`,ve=$(A)`
  ${({$isClear:e})=>e?"animation: clear-row 500ms ease-in-out infinite alternate;":""}

  @keyframes clear-row {
    0% {
      opacity: 1;
    }
    100% {
      opacity: 0;
    }
  }
`;function N(e){const{rowData:t,$isClear:n,col:o}=e,{col:s}=I("col");return g.jsx(ve,{$flex:"1",$gap:"0.5",$isClear:n,children:he(t,o||s).map((i,r)=>g.jsx(xe,{$active:String(i)==="1"},r))})}const Ee=l.memo(function(e){const{elementInfo:t}=e,{elementData:n=[],size:o}=t;return g.jsx(we,{$gap:"0.5",$direction:L.column,children:n.map((s,i)=>g.jsx(N,{rowData:s,col:o},i))})});function Ae(){const{gameStatus:e}=I("gameStatus"),t=e===p.running;return g.jsx(ue,{buttons:[{text:t?"暂停":"开始",onClick(){y({id:`elsfk-${t?"pause":"start"}`,type:t?d.PAUSE:d.START})}},{text:"重置",onClick(){y({id:"elsfk-reload",type:d.RELOAD})}}]})}function Ce(){const{row:e,col:t,moveAddRow:n}=I(["row","col","moveAddRow"]),o=e+n,s=l.useRef(500),i=l.useRef(!1),r=l.useMemo(()=>fe(o,e),[o,e]),c=l.useRef(r(!1)),a=l.useRef(r(!0)),m=l.useRef({}),h=l.useRef({}),[F,Z]=l.useState(k(n,c.current,a.current)),[q,O]=l.useState([]),D=l.useRef(0),T=l.useMemo(()=>(1<<t)-1,[t]),S=l.useCallback(()=>{Z(k(n,c.current,a.current))},[n]),M=l.useMemo(()=>ge(t,o,n),[t,o,n]),R=l.useCallback(()=>{const u=h.current;let f=G(t);new Array(Math.floor(Math.random()*4)).forEach(()=>f=z(f));const w=K(t,u);h.current=f,m.current=u,a.current=r(!0),a.current.unshift(...w),a.current.splice(o)},[r,o,t]);U("keydown",u=>{if(u.code==="ArrowLeft")a.current=M("left",c.current,a.current),m.current.rightSpace+=1,S();else if(u.code==="ArrowRight")a.current=M("right",c.current,a.current),m.current.rightSpace-=1,S();else if(u.code==="ArrowUp"){m.current=z(m.current);const f=K(t,m.current);a.current=[...f].concat(new Array(o-f.length).fill(0)),S()}else if(u.code==="ArrowDown"){if(i.current)return;i.current=!0,s.current/=4}}),U("keyup",u=>{u.code==="ArrowDown"&&(i.current=!1,s.current*=4)});const _=l.useCallback(()=>{x().setGameStatus(p.over);const u={gameId:x().gameId,score:D.current};re(me,{...u,time:Date.now()}),ne(),C.event("game-elsfk-over",u),C.expose("game-elsfk-over"),y({id:"reload-history",type:d.RELOAD_HISTORY}),oe().showMessage({content:`游戏结束, 得分: ${D.current}`})},[]),v=l.useMemo(()=>se(()=>{x().gameStatus===p.running&&setTimeout(()=>{try{a.current=M("bottom",c.current,a.current),m.current.topPos+=1}catch(f){const w=f;if(w.custom&&w.action==="submit"){const E=k(n,c.current,a.current);c.current=E;const b=de(e,E,T);if(b.length){D.current+=b.length*t,O(b),setTimeout(()=>{b.forEach(X=>{E.splice(X,1),E.unshift(0)}),O([]),R(),v()},2e3);return}if(E[0])return _();R()}}S(),v()},s.current)},10),[M,R,T,n,e,t,S,_]),j=l.useCallback((u=!1)=>{c.current=r(!1),a.current=r(!0),h.current=u?{}:G(t),s.current=500,i.current=!1},[r,t]),Q=l.useCallback(()=>{x().gameStatus===p.over&&(x().setGameStatus(p.running),j(),R(),v())},[R,v,j]);return Se(({type:u})=>{const{setGameStatus:f,gameStatus:w}=x();u===d.START?w===p.pause?(f(p.running),v()):Q():u===d.PAUSE?f(p.pause):u===d.RELOAD&&(j(!0),f(p.over),S())}),g.jsx(ae,{children:g.jsxs(A,{$flex:"1",$alignItems:ce.center,$justifyContent:B.center,$gap:"1",$direction:L.column,children:[g.jsxs(Re,{children:["当前得分: ",D.current]}),g.jsxs(A,{$gap:"1",$justifyContent:B.center,children:[g.jsx(J,{$gap:"0.5",$direction:L.column,children:F.map((u,f)=>g.jsx(N,{rowData:u,$isClear:q.includes(f)},f))}),g.jsx(A,{children:g.jsx(Ee,{elementInfo:h.current})})]})]})})}const Le={title:"俄罗斯方块",needBackIcon:!0,rightArea:g.jsx(Ae,{})};export{Ce as Component,Le as handle};
