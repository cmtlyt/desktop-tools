import{h as V,g as X,W as x,l as O}from"./index-KNKRzeP1.js";import"./index-CHoudlAF.js";import{N as Y}from"./opfs-key-D0VDwJ2Y.js";import{a as Z,g as ee}from"./opfs-BPlJtuxg.js";const te="/desktop-tools/";var E={};const R=Symbol&&Symbol("empty")||{},U=Reflect!=null&&Reflect.apply?e=>{let t=R;return(...s)=>(t===R&&(t=e()),typeof t!="function"?t:Reflect.apply(t,null,s))}:e=>{let t=R;return(...s)=>(t===R&&(t=e()),typeof t!="function"?t:t.apply(null,s))},re=U(()=>globalThis.navigator?globalThis.navigator.userAgent||globalThis.navigator.swuserAgent:process?`Node.js/${process.version} (${process.platform}; ${process.arch}) ${E.SHELL} ${E.LANG} ${E.TERM_PROGRAM}`:""),ne=U(()=>!re().toLocaleLowerCase().includes("node")&&window&&"onload"in window);function A(...e){var t;(t=globalThis==null?void 0:globalThis.__ClConfig__)!=null&&t.disableWarning||console.warn("@cmtlyt/base:>",...e)}function p(e){return ne()?typeof window<"u"&&window[e]!==void 0:(A("caniuse 只能在浏览器环境中使用"),!1)}function se(e){return e.byteLength>=65556&&A("buffer size too large, use arrayBufferToChunkBase64String"),btoa(String.fromCharCode.apply(null,new Uint8Array(e)))}function oe(e){const t=e.split("|");return new Blob(t.map(s=>function(r){r.length>=65556&&A("base64 size too large, use chunkBase64StringToArrayBuffer");const n=atob(r),o=n.length,c=new Uint8Array(o);for(let i=0;i<o;i++)c[i]=n.charCodeAt(i);return c}(s)))}async function ae(e){return function(t){const r=[];let n=t.slice(r.length*10240,r.length*10240+10240);for(;n.byteLength>0;)r.push(se(n)),n=t.slice(r.length*10240,r.length*10240+10240);return r.join("|")}(await async function(t){const s=t.getReader(),r=[];let n=0;for(;;){const{done:i,value:a}=await s.read();if(i)break;r.push(a),n+=a.byteLength}const o=new ArrayBuffer(n);let c=0;for(const i of r){const a=new Uint8Array(i);new Uint8Array(o,c,a.length).set(a),c+=a.length}return o}(e))}var _,M=1e3,h=6e4,m=60*h,w=24*m,ce=7*w;function L(e,t,s,r){var n=t>=1.5*s;return Math.round(e/s)+" "+r+(n?"s":"")}function C(e=8){const t=Math.random().toString(36).slice(2,e+2);return t.length===e?t:t+C(e-t.length)}function P(e){const t=new Blob([e]);return URL.createObjectURL(t)}function B(e){return new Worker(e)}function T(){const e=[],t=r=>{e.push(r)},s=r=>{e.splice(e.indexOf(r),1)};return{on:t,remove:s,clearOn:()=>{e.length=0},onOnce:r=>{const n=(...o)=>{r.apply(null,o),s(n)};t(n)},emit:r=>{for(const n of e)n(r)}}}function D({emit:e,type:t,result:s,error:r,resolve:n=()=>{},reject:o=()=>{},isSysCall:c,eventData:i}){if(c)t==="success"?n(s):o(r);else{const{__clUserCall:a,data:l}=i;e(a?l:i)}}function I(e,t=[],s){if(!p("Worker"))return A("不支持 web worker 已降级"),{run:async(...a)=>await e(...a),dispose:()=>{},...T()};const{reuse:r=!0,needPost:n=!1}=s,o=function(a,l=[],f=!1){return`
${l.length?`importScripts("${l.join('", "')}");`:""}
const func = ${a};

const { postMessage } = (()=>{
  const postMessage = (data) => {
    self.postMessage({ __clUserCall: true, data })
  };
  return { postMessage: (data) => postMessage(data) };
})();

self.onmessage = async (e) => {
  const { callId, data: args } = e.data
  try {
    const result = await func.apply(null, ${f?"[postMessage, ...args]":"args"});
    self.postMessage({ __clSysCall: true, type: 'success', result, callId });
  } catch (e) {
    self.postMessage({ __clSysCall: true, callId, type: 'error', error: e })
  }
}
self.onerror = (e) => {
  self.postMessage({ __clSysCall: true, type: 'error', error: e })
}`}(e,function(a){const l=[],f=[];return a.forEach(u=>{typeof u=="string"?f.push(u):typeof u=="function"&&l.push(u)}),f.push(P(l.map(u=>`function ${u.name}(...args) { return (${u})(...args); }`).join(`
`))),f}(t),n),c=P(o);return r?function(l){const f=B(l);let u=!1,g={};const{emit:S,...N}=T();return f.onmessage=y=>{const{type:d,result:b,error:v,callId:k,__clSysCall:$}=y.data,{resolve:K,reject:Q}=g[k]||{};$&&delete g[k],D({emit:S,type:d,result:b,error:v,resolve:K,reject:Q,isSysCall:$,eventData:y.data})},{run:async(...y)=>{if(u)throw new Error("worker资源已释放");const d=C(16);return new Promise((b,v)=>{g[d]={resolve:b,reject:v},f.postMessage({callId:d,data:y})})},dispose:()=>{f.terminate(),g=null,u=!0,URL.revokeObjectURL(l)},...N}}(c):function(a){let l=!1;const{emit:f,...u}=T();return{run:async(...g)=>{if(l)throw new Error("worker资源已释放");const S=B(a);return new Promise((N,y)=>{S.onmessage=d=>{const{type:b,result:v,error:k,__clSysCall:$}=d.data;$&&S.terminate(),D({emit:f,type:b,result:v,error:k,resolve:N,reject:y,isSysCall:$,eventData:d.data})},S.postMessage({data:g})})},dispose:()=>{l=!0,URL.revokeObjectURL(a)},...u}}(c)}function j(e,t){let s,r=0;const n=36**t;for(;e.includes(s=C(t))&&++r<n;);return s}function F(e){return"#"}function W(e,t,s="#",r={}){const n=new RegExp(`(^{.*?(.{${t}})})|({.*?(.{${t}})}$)`),o=s.length+2;for(let c=0;c++<e.length;){const i=e.slice(c,c+t+o);if(e.includes(i,c+t+o))for(let a=c+t+o+1;a++<e.length;){const l=e.slice(c,a);if(!e.includes(l,a)){const f=j(Object.keys(r),t),u=e.slice(c,a-1);if(n.test(u))break;r[f]=u,e=e.replace(new RegExp(u.replace(/([[{(?)\\])/g,"\\$1"),"g"),`{${s}${f}}`),c+=9;break}}}return e}function z(e,t=6){const s={},r=W(e,t,"#",s);return JSON.stringify({cache:s,source:r,keyLength:t})}_=function(e,t){t=t||{};var s=typeof e;if(s==="string"&&e.length>0)return function(r){if(!((r=String(r)).length>100)){var n=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(n){var o=parseFloat(n[1]);switch((n[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return o*ce;case"days":case"day":case"d":return o*w;case"hours":case"hour":case"hrs":case"hr":case"h":return o*m;case"minutes":case"minute":case"mins":case"min":case"m":return o*h;case"seconds":case"second":case"secs":case"sec":case"s":return o*M;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}}}(e);if(s==="number"&&isFinite(e))return t.long?function(r){var n=Math.abs(r);return n>=w?L(r,n,w,"day"):n>=m?L(r,n,m,"hour"):n>=h?L(r,n,h,"minute"):n>=M?L(r,n,M,"second"):r+" ms"}(e):function(r){var n=Math.abs(r);return n>=w?Math.round(r/w)+"d":n>=m?Math.round(r/m)+"h":n>=h?Math.round(r/h)+"m":n>=M?Math.round(r/M)+"s":r+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))},_&&_.__esModule&&Object.prototype.hasOwnProperty.call(_,"default")&&_.default;I(z,[W,F,j,C],{reuse:!1});function H(e,t="#"){const{keyLength:s,cache:r}=e;let n,{source:o}=e;for(;n=new RegExp(`{${t}(.{${s}})}`,"g").exec(o);){const[c,i]=Array.from(n);o=o.replace(new RegExp(c,"g"),r[i])}return o}function J(e){return H(JSON.parse(e),"#")}I(J,[H,F,j,C],{reuse:!1});const G=U(()=>p("TextEncoder")&&p("ReadableStream")&&p("ArrayBuffer")&&p("Uint8Array")&&p("btoa")&&p("atob")&&p("TextDecoder"));async function q(e,t=6){if(!p("CompressionStream")||!G())return z(e,t);const s=function(r){const n=new TextEncoder;return new ReadableStream({start(o){o.enqueue(n.encode(r)),o.close()}})}(e).pipeThrough(new CompressionStream("gzip"));return ae(s)}async function ge(e){if(!p("DecompressionStream")||!G())return J(e);const t=await async function(s){return oe(s).stream()}(e);return async function(s){const r=s.getReader(),n=[];let o="";for(;;){const{done:i,value:a}=await r.read();if(i)break;n.push(a)}const c=new TextDecoder("utf-8");for(const i of n)o+=c.decode(i);return o+=c.decode(),o}(t.pipeThrough(new DecompressionStream("gzip")))}const{useStore:ye,useStoreSlice:he,getStore:me}=V(e=>({currentNotepad:void 0,setNotepad:t=>e({currentNotepad:t})}));async function ie(e){const{url:t}=e;if(!t)return e;const s=await ee(t);return{...e,content:s,url:""}}async function we(e){try{const t=await ie(e),s=await q(JSON.stringify(t)),r=new URL(`./#/notepad/preview/source/${encodeURIComponent(s)}`,`${location.protocol}//${location.host}${te}`),{showMessage:n}=X();if(!x.isCopyable)return O.error("copy-not-support","shareNotepad",{id:e.id}),n({content:"您的浏览器不支持复制",type:"warning"});O.event("share-notepad",{id:e.id}),x.copy(r.href),n({content:"复制成功",type:"success"})}catch(t){O.error("share-notepad-error","shareNotepad",t.stack||t.message,{id:e.id})}}function ue(e){return e?`${Y}${e}`:""}async function Se(e,t){const s=await q(t),r=ue(`${e}.mdx`),n=await Z(r);return await n.write(s),await n.close(),r}export{ge as U,we as a,me as g,Se as s,he as u};
