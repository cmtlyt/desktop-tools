import{l as S,r as n,aR as E,aJ as y,aS as w,aT as I,n as P,j as s,G as A}from"./index-Ch4bek_b.js";import{C as H,u as U,W as T,a as W,I as B,U as O,S as _,P as F}from"./page-aPM0RkI2.js";import{u as G}from"./use-navigate-Cl-uM-Ch.js";import{A as M}from"./index-D0Yvu1ca.js";import{B as V}from"./index-CiOg3lfn.js";import{S as v}from"./index-Baf81WNP.js";import{P as $}from"./constant-Dqe_e0L0.js";import{c as K,S as N}from"./Subject-CC7OZsq2.js";import{i as q}from"./is-phone-DqVyIJsf.js";import"./button-ChdjSb5e.js";import"./index-D6D3cjcs.js";import"./asyncToGenerator-CdfDXCsZ.js";import"./reactNode-xDrto8Ml.js";import"./PurePanel-CD-7UOLN.js";import"./UnstableContext-u56mSdlo.js";import"./compact-item-DXyW-YUr.js";import"./LoadingOutlined-Bls90OqU.js";import"./pickAttrs-CGR3EVLK.js";import"./useLocale-CkrnKRaz.js";import"./BaseInput-DQvut5eX.js";import"./index-Dmq0dSt8.js";import"./index-BkUqqAG2.js";import"./useForceUpdate-CCJXZqCB.js";import"./EyeOutlined-DViBBPDs.js";import"./index-CT63zqzo.js";import"./fade-CP-LmfEu.js";import"./index-Bc7HFi3C.js";import"./iconBase-DzU9LrI2.js";import"./index-B4g9YTQJ.js";import"./index-D88M7-Vq.js";var j=(e=>(e.PREVIEW_IMAGE="preview_image",e))(j||{});const C=new N;function z(e){var r;C.next(e),(r=e.ext)!=null&&r.disableAutoLogger||S.event("pht-action",e)}const J=K(C);function Y(e){return new Proxy({async action(r,t,a=[]){var d,g;const{promise:i,resolve:p}=E(),l=({data:{result:m}})=>{var o;p(m),(o=e.current)==null||o.removeEventListener("message",l)};return(d=e.current)==null||d.addEventListener("message",l),(g=e.current)==null||g.postMessage({action:r,option:t},a),i}},{get(r,t,a){if(t in r)return Reflect.get(r,t,a);const i=e.current[t];return typeof i=="function"?i.bind(e.current):i}})}function D(e,r){const t=n.useRef(null),a=n.useMemo(()=>Y(t),[]);return n.useEffect(()=>(t.current=new Worker(e,{type:"module"}),r==null||r(a),()=>{var i;(i=t.current)==null||i.terminate()}),[e]),a}const Q="/desktop-tools/assets/compose-worker-BSRs1k8F.js";function X(){const e=n.useRef(document.createElement("canvas")),r=n.useRef({dirty:!0,width:0,height:0,images:[],jitterRange:30,replaceColor:"#000000",filterList:[]}),t=D(Q,w(o=>{S.warn("如果需要调整本页面相关内容, 请先关闭 React 的严格渲染模式"),I(()=>{var f;const c=(f=e.current)==null?void 0:f.transferControlToOffscreen();!c||!o||o.action("init",{offscreen:c},[c])})})),[a,i]=n.useState(""),[p,l]=n.useState(!1),[d,g]=n.useState("");n.useEffect(()=>{const o=c=>{g(c.message),l(!1)};return t.addEventListener("error",o),()=>{t.removeEventListener("error",o)}},[t]);const m=n.useCallback(async(o,c={})=>{if(g(""),!e.current||!o.length){i("");return}const{replaceColor:f="#000000",jitterRange:h=30}=c;l(!0);const u=r.current;return Promise.resolve().then(()=>{if(!(u.images.toString()===o.toString()&&u.jitterRange===h&&u.replaceColor===f))return u.dirty=!0,u.images=o,u.jitterRange=h,u.replaceColor=f,t.action("compose",{imgs:o,options:c})}).then(()=>{var R;if(!(!u.dirty&&u.filterList.toString()===((R=c.filterList)==null?void 0:R.toString())))return u.dirty=!0,u.filterList=c.filterList||[],t.action("filter",{filterList:c.filterList})}).then(async()=>{if(!u.dirty)return;await t.action("drawImage"),await y(100);const{promise:R,resolve:x}=E();return e.current.toBlob(b=>{if(!b)return x(void 0);URL.revokeObjectURL(a);const k=URL.createObjectURL(b);i(k),x(void 0)}),R}).finally(()=>{u.dirty=!1,l(!1)})},[a,t]);return{loading:p,imageUrl:a,error:d,compose:m}}const{useStoreSlice:L,getStore:Z}=P(e=>({fullback:!1,setFullback(r){e({fullback:r})}}));function ee(){const e=G(),r=n.useRef([]),t=n.useRef([]),a=n.useRef(null),{loading:i,imageUrl:p,error:l,compose:d}=X(),g=U($,()=>{e(-1)});J(()=>{window.open(p)},[j.PREVIEW_IMAGE]);const m=n.useCallback(A(f=>{var h;r.current=f||(f=r.current),d(f,{filterList:t.current,...(h=a.current)==null?void 0:h.getValue()})},500),[t,d]),o=n.useCallback(f=>{t.current=f,m()},[m]),c=n.useCallback(()=>{m()},[m]);return g?s.jsx(M,{onFirstAppear:()=>S.appear("tool-pht"),children:s.jsxs(T,{$flex:"1",$direction:"column",children:[s.jsx(W,{ref:a,onChange:c}),s.jsx(B,{onChange:o}),s.jsx(O,{onChange:m}),s.jsxs(_,{spinning:i,delay:100,size:"large",tip:"处理中...",children:[s.jsx(v,{when:p&&!l,children:()=>s.jsx(F,{src:p})}),s.jsx(v,{when:l,children:()=>s.jsx("span",{style:{color:"red"},children:l})})]})]})}):null}function He(){const{fullback:e}=L("fullback");return e?s.jsx(H,{}):s.jsx(ee,{})}function te(){const{fullback:e}=L("fullback");return s.jsx(V,{buttons:[...e?[]:[{text:"降级",onClick:()=>Z().setFullback(!0)}],{text:"预览",hidden:q(),onClick(){z({id:"preview-image",type:j.PREVIEW_IMAGE})}}]})}const Ue={title:"拼好图",needBackIcon:!0,rightArea:s.jsx(te,{})};export{He as Component,Ue as handle};
