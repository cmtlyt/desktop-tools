import{aP as $,a2 as W,r as l,j as d,l as P,E as H}from"./index-DcZ2pANc.js";import{u as N,W as T,C as V,I as B,U as F,P as K}from"./component-Dy0WxrvD.js";import{u as M}from"./use-navigate-ghhqHgEc.js";import{A as q}from"./index-ChYcQMZ7.js";import{S as G}from"./index-Baf81WNP.js";import{d as Y}from"./button-Ch2TvbCU.js";import{P as z}from"./constant-Dqe_e0L0.js";import"./index-0kWlctU-.js";import"./asyncToGenerator-BcjGD0Qn.js";import"./reactNode-BNBQyY1s.js";import"./PurePanel-DkOr-iRc.js";import"./UnstableContext-yAUbyLg4.js";import"./compact-item-Z3TGKqzP.js";import"./LoadingOutlined-vQm4KgZI.js";import"./pickAttrs-CnoVZ5cH.js";import"./useLocale-Clf7rP0V.js";import"./BaseInput-A62ngUWK.js";import"./index-DwUFYxEz.js";import"./index-CzZvb85b.js";import"./DownOutlined-BJcyReC2.js";import"./index-kCCpzCeX.js";import"./index-BiBuMtNh.js";import"./index-S9R6XXnE.js";import"./fade-C2v5s6aI.js";const J=$(async()=>W(()=>import("./index-CNJbZSZ9.js").then(t=>t.i),[]));async function D(t,a){const e=await J();return a.reduce((r,o)=>{var i;return((i=e[o])==null?void 0:i.call(e,r))||r},t)}function Q(t){var o;if(t.startsWith("#")){const[i,C,v]=((o=t.match(/\w{2}/g))==null?void 0:o.map(p=>parseInt(p,16)))??[];return{r:i,g:C,b:v}}else t.startsWith("rgb")&&(t=t.replace(/^rgba?\((.*?)\)$/,"$1"));const[a=0,e=0,r=0]=t.split(",").map(i=>parseInt(i.trim(),10)).filter(i=>!isNaN(i));return{r:a,g:e,b:r}}function X(t,a,e){return t.every((r,o)=>Math.abs(r-a[o])<e)}async function Z(t,a){var r,o;if(!t||t.imgs.join(",")!==a.imgs.join(",")||t.options.replaceColor!==a.options.replaceColor||t.options.jitterRange!==a.options.jitterRange)return null;if(((r=t.options.filterList)==null?void 0:r.join(","))===((o=a.options.filterList)==null?void 0:o.join(",")))return t.result;if(t.options.filterList=a.options.filterList,!t.result)return null;const e=_(t.result.oriImageData);return t.result.imageUrl="",t.options.filterList?(t.result.imageData=await D(e,t.options.filterList),t.result):(t.result.imageData=e,t.result)}function _(t){return new ImageData(new Uint8ClampedArray(Array.from(t.data)),t.width,t.height)}const tt=Y.canvas`
  display: none;
`,et=l.memo(l.forwardRef(function(t,a){const e=l.useRef(null),r=l.useRef(null),o=l.useRef(null),i=n=>{if(!e.current||!n)return;const c=r.current||(r.current=e.current.getContext("2d"));c&&(C(c),e.current.width=n.width,e.current.height=n.height,c.putImageData(n,0,0))},C=n=>{var c;n||(n=r.current||(r.current=(c=e.current)==null?void 0:c.getContext("2d"))),n&&n.clearRect(0,0,n.canvas.width,n.canvas.height)},v=async(n,c={})=>{if(!e.current)return null;if(!n.length)return C(),null;const u=await Z(o.current,{imgs:n,options:c});if(u){const{imageData:s}=u;return P.appear("pht.compose.appear-cache"),i(s),u}const f=document.createElement("canvas"),m=f.getContext("2d");return m?Promise.all(n.map(s=>{const g=new Image;return new Promise(h=>{g.onload=()=>h(g),g.src=s})})).then(s=>{if(!s.length)return null;const{replaceColor:g="#000000",jitterRange:h=10}=c,{r:I,g:A,b:S}=Q(g),U=[I,A,S],{width:y,height:L}=s[0],x={width:y,height:L,data:Array.from({length:y*L*4},(j,b)=>{const w=b%4;return w===3?255:U[w]})};return s.forEach(j=>{f.width=j.width,f.height=j.height,m.drawImage(j,0,0);const b=m.getImageData(0,0,j.width,j.height);C(m);const{data:w}=b;for(let R=0;R<w.length;R+=4){const E=[w[R],w[R+1],w[R+2],w[R+3]];X(E.slice(0,3),U,h)||E.forEach((O,k)=>x.data[R+k]=O)}}),x}).then(async s=>{if(!s)return null;const{filterList:g=[]}=c,h=m.createImageData(s.width,s.height,{colorSpace:"srgb"});h.data.set(s.data);const I={oriImageData:_(h),imageData:h,imageUrl:""};return g.length&&(I.imageData=await D(h,g)),I}).then(async s=>{if(o.current={result:s,imgs:n,options:c},!s)return null;const{autoRender:g=!0}=c,{imageData:h}=s;return g&&i(h),s.imageUrl=await p()||"",s}):null},p=async(n=!1)=>{var c,u;return!n&&((u=(c=o.current)==null?void 0:c.result)!=null&&u.imageUrl)?o.current.result.imageUrl:new Promise(f=>{e.current&&e.current.toBlob(m=>{if(!m)return f(void 0);f(URL.createObjectURL(m))},"image/webp",1)})};return l.useImperativeHandle(a,()=>({compose:v,render:i,getImageUrl:p,clear:()=>C()})),d.jsx(tt,{ref:e,...t})}));function Lt(){const t=M(),a=l.useRef(null),e=l.useRef([]),r=l.useRef([]),o=l.useRef(null),[i,C]=l.useState(),v=N(z,()=>{t(-1)}),p=l.useCallback(H(u=>{var f;if(!(u!=null&&u.length)){if(!e.current.length)return;u=e.current}e.current=u,a.current&&a.current.compose(u,{filterList:r.current,...(f=o.current)==null?void 0:f.getValue()}).then(()=>a.current.getImageUrl()).then(m=>{URL.revokeObjectURL(i||""),C(m)})},500),[r,i]),n=l.useCallback(u=>{r.current=u,p()},[p]),c=l.useCallback(()=>{p()},[p]);return v?d.jsx(q,{onFirstAppear:()=>P.appear("tool-pht-fullback"),children:d.jsxs(T,{$flex:"1",$direction:"column",children:[d.jsx(V,{ref:o,onChange:c}),d.jsx(B,{onChange:n}),d.jsx(F,{onChange:p}),d.jsx(et,{ref:a}),d.jsx(G,{when:i,children:()=>d.jsx(K,{src:i})})]})}):null}export{Lt as Component,Lt as default};
