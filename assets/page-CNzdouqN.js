import{r as l,x as p}from"./index-OqKSztoA.js";import{i as ee,C as F,j as te,l as b,d as C,c as j,b as v,D as re,E as ne,g as oe,H as se,A as ae,a as ce,F as P}from"./index-DJiqVJxb.js";import{B as ue}from"./index-Cyrdyi8q.js";import{S as ie,c as le}from"./create-action-subscribe-hook-DIKyaA4Y.js";import{E as me}from"./constant-DnvxCFPa.js";import"./index-rKcQqYvY.js";const G=["0/15/0/0","2/2/3","3/3","3/6/0","6/3/0","0/7/2","2/2/6"];function fe(e,t){return n=>new Array(n?e:t).fill(0)}function N(e,t,n){return t.map((o,s)=>o|n[s+e])}function _(e){const t=Math.floor(Math.random()*G.length),n=G[t].split("/"),o=n.length,s=Math.floor((e-o)/2),i=n.map(r=>parseInt(r,10));return{size:o,elementData:i,rightSpace:s,topPos:0,width:K(i)}}function pe(e,t,n){return(o,s,i)=>{const r=[...i];switch(o){case"left":{if(r.some((c,a)=>{const m=s[a-n];return m&&m&c<<1?!0:c&1<<e-1}))break;return r.map(c=>c<<1)}case"right":{if(r.some((c,a)=>{const m=s[a-n];return m&&m&c>>1?!0:c&1}))break;return r.map(c=>c>>1)}case"bottom":{const c=r.slice(2).some((m,h)=>s[h+1]&m),a=r[t-1];if(c||a)throw{custom:!0,action:"submit"};r.unshift(0),r.pop();break}default:return r}return r}}function ge(e,t){return t.map(n=>n.toString(2).padStart(e,"0").split(""))}function K(e){return Math.max(...e.map(t=>t.toString(2).replace(/(^0+)|(0+$)/g,"").length))}function V(e,t){const{elementData:n,rightSpace:o,topPos:s,width:i}=t;let r=o;return r-i/2<0?r=0:r+i>e&&(r=e-i),t.rightSpace=r,new Array(s).fill(0).concat(n.map(c=>c<<r))}function B(e){const{size:t,elementData:n}=e,o=ge(t,n),s=Array.from({length:o.length},()=>new Array(o.length));for(let r=0;r<o.length;++r){const c=o[r];for(let a=0;a<c.length;++a)s[t-1-a][r]=o[r][a]}const i=s.map(r=>parseInt(r.join(""),2));return{...e,elementData:i,width:K(i)}}function de(e,t,n){const o=[];for(let s=0;s<e;++s)t[s]===n&&o.push(s);return o}function he(e,t){return e.toString(2).padStart(t).split("")}function H(e,t){l.useEffect(()=>(window.addEventListener(e,t),()=>window.removeEventListener(e,t)),[e,t])}var g=(e=>(e.RUNNING="running",e.PAUSE="pause",e.OVER="over",e))(g||{});const z=ee(e=>({gameId:F(),row:20,col:10,moveAddRow:2,gameStatus:"over",setRow:t=>e({row:t}),setCol:t=>e({col:t}),setMoveAddRow:t=>e({moveAddRow:t}),updateGameId:()=>e({gameId:F(),gameStatus:"over"}),setGameStatus:t=>e({gameStatus:t})})),I=e=>z(te(e)),R=()=>z.getState();var d=(e=>(e.RELOAD_HISTORY="reload_history",e.START="start",e.PAUSE="pause",e.RELOAD="reload",e))(d||{});const Y=new ie;function k(e){Y.next(e),b.event("ELSFK-action",e)}const Se=le(Y),W=C(v)`
  width: 40vh;
  height: 80vh;
  color: var(--color-primary);
`,we=C(W)`
  width: 15vmin;
  height: 15vmin;
`,Re=C.div`
  flex: 1;
  color: ${e=>e.$active?"inherit":"#0002"};
  box-shadow:
    inset 0 0 0 0.2rem currentColor,
    inset 0 0 0 0.8rem #fff ${e=>e.$active?", inset 0 0 0 10rem currentColor":""};
`,Ee=C.span`
  font-size: 2rem;
`,xe=C(v)`
  ${({$isClear:e})=>e?"animation: clear-row 500ms ease-in-out infinite alternate;":""}

  @keyframes clear-row {
    0% {
      opacity: 1;
    }
    100% {
      opacity: 0;
    }
  }
`;function J(e){const{rowData:t,$isClear:n,col:o}=e,{col:s}=I("col");return p.jsx(xe,{$flex:"1",$gap:"0.5",$isClear:n,children:he(t,o||s).map((i,r)=>p.jsx(Re,{$active:String(i)==="1"},r))})}const Ae=l.memo(function(e){const{elementInfo:t}=e,{elementData:n=[],size:o}=t;return p.jsx(we,{$gap:"0.5",$direction:j.COLUMN,children:n.map((s,i)=>p.jsx(J,{rowData:s,col:o},i))})});function ve(){const{gameStatus:e}=I("gameStatus"),t=e===g.RUNNING;return p.jsx(ue,{buttons:[{text:t?"暂停":"开始",onClick(){k({id:`elsfk-${t?"pause":"start"}`,type:t?d.PAUSE:d.START})}},{text:"重置",onClick(){k({id:"elsfk-reload",type:d.RELOAD})}}]})}function be(){const{row:e,col:t,moveAddRow:n}=I(["row","col","moveAddRow"]),o=e+n,s=l.useRef(500),i=l.useRef(!1),r=l.useMemo(()=>fe(o,e),[o,e]),c=l.useRef(r(!1)),a=l.useRef(r(!0)),m=l.useRef({}),h=l.useRef({}),[y,Z]=l.useState(N(n,c.current,a.current)),[q,O]=l.useState([]),M=l.useRef(0),U=l.useMemo(()=>(1<<t)-1,[t]),S=l.useCallback(()=>{Z(N(n,c.current,a.current))},[n]),$=l.useMemo(()=>pe(t,o,n),[t,o,n]),E=l.useCallback(()=>{const u=h.current;let f=_(t);new Array(Math.floor(Math.random()*4)).forEach(()=>f=B(f));const w=V(t,u);h.current=f,m.current=u,a.current=r(!0),a.current.unshift(...w),a.current.splice(o)},[r,o,t]);H("keydown",u=>{if(u.code==="ArrowLeft")a.current=$("left",c.current,a.current),m.current.rightSpace+=1,S();else if(u.code==="ArrowRight")a.current=$("right",c.current,a.current),m.current.rightSpace-=1,S();else if(u.code==="ArrowUp"){m.current=B(m.current);const f=V(t,m.current);a.current=[...f].concat(new Array(o-f.length).fill(0)),S()}else if(u.code==="ArrowDown"){if(i.current)return;i.current=!0,s.current/=4}}),H("keyup",u=>{u.code==="ArrowDown"&&(i.current=!1,s.current*=4)});const T=l.useCallback(()=>{R().setGameStatus(g.OVER);const u={gameId:R().gameId,score:M.current};re(me,{...u,time:Date.now()}),ne(),b.event("game-elsfk-over",u),b.expose("game-elsfk-over"),k({id:"reload-history",type:d.RELOAD_HISTORY}),oe().showMessage({content:`游戏结束, 得分: ${M.current}`})},[]),x=l.useMemo(()=>se(()=>{R().gameStatus===g.RUNNING&&setTimeout(()=>{try{a.current=$("bottom",c.current,a.current),m.current.topPos+=1}catch(f){const w=f;if(w.custom&&w.action==="submit"){const A=N(n,c.current,a.current);c.current=A;const D=de(e,A,U);if(D.length){M.current+=D.length*t,O(D),setTimeout(()=>{D.forEach(X=>{A.splice(X,1),A.unshift(0)}),O([]),E(),x()},2e3);return}if(A[0])return T();E()}}S(),x()},s.current)},10),[$,E,U,n,e,t,S,T]),L=l.useCallback((u=!1)=>{c.current=r(!1),a.current=r(!0),h.current=u?{}:_(t),s.current=500,i.current=!1},[r,t]),Q=l.useCallback(()=>{R().gameStatus===g.OVER&&(R().setGameStatus(g.RUNNING),L(),E(),x())},[E,x,L]);return Se(({type:u})=>{const{setGameStatus:f,gameStatus:w}=R();u===d.START?w===g.PAUSE?(f(g.RUNNING),x()):Q():u===d.PAUSE?f(g.PAUSE):u===d.RELOAD&&(L(!0),f(g.OVER),S())}),p.jsx(ae,{children:p.jsxs(v,{$flex:"1",$alignItems:ce.CENTER,$justifyContent:P.CENTER,$gap:"1",$direction:j.COLUMN,children:[p.jsxs(Ee,{children:["当前得分: ",M.current]}),p.jsxs(v,{$gap:"1",$justifyContent:P.CENTER,children:[p.jsx(W,{$gap:"0.5",$direction:j.COLUMN,children:y.map((u,f)=>p.jsx(J,{rowData:u,$isClear:q.includes(f)},f))}),p.jsx(v,{children:p.jsx(Ae,{elementInfo:h.current})})]})]})})}const je={title:"俄罗斯方块",needBackIcon:!0,rightArea:p.jsx(ve,{})};export{be as Component,je as handle};
