var $=Object.defineProperty;var K=(e,t,r)=>t in e?$(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var o=(e,t,r)=>K(e,typeof t!="symbol"?t+"":t,r);const Z="https://stackblitz.com",ee=new Error;ee.stack="";const v={};let b=null;const k={get editorOrigin(){return b==null&&(b=new URL(globalThis.WEBCONTAINER_API_IFRAME_URL??Z).origin),b},set editorOrigin(e){b=new URL(e).origin},setQueryParam(e,t){v[e]=t},get url(){const e=new URL(this.editorOrigin);e.pathname="/headless";for(const t in v)e.searchParams.set(t,v[t]);return e.searchParams.set("version","1.6.1"),e}};function te(){let e,t;function r(){t=new Promise(n=>e=n)}return r(),{get promise(){return t},resolve(n){return e(n)},reset:r}}te();var g;(function(e){e.UncaughtException="PREVIEW_UNCAUGHT_EXCEPTION",e.UnhandledRejection="PREVIEW_UNHANDLED_REJECTION",e.ConsoleError="PREVIEW_CONSOLE_ERROR"})(g||(g={}));var re=Object.defineProperty,ne=(e,t)=>{for(var r in t)re(e,r,{get:t[r],enumerable:!0})},w={};ne(w,{createEndpoint:()=>D,expose:()=>U,proxy:()=>G,proxyMarker:()=>C,releaseProxy:()=>j,transfer:()=>B,transferHandlers:()=>T,windowEndpoint:()=>ce,wrap:()=>V});var C=Symbol("Comlink.proxy"),D=Symbol("Comlink.endpoint"),j=Symbol("Comlink.releaseProxy"),O=Symbol("Comlink.thrown"),W=e=>typeof e=="object"&&e!==null||typeof e=="function",se={canHandle:e=>W(e)&&e[C],serialize(e){const{port1:t,port2:r}=new MessageChannel;return U(e,t),[r,[r]]},deserialize(e){return e.start(),V(e)}},ie={canHandle:e=>W(e)&&O in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},T=new Map([["proxy",se],["throw",ie]]);function U(e,t=self){t.addEventListener("message",function r(n){if(!n||!n.data)return;const{id:s,type:a,path:i}=Object.assign({path:[]},n.data),c=(n.data.argumentList||[]).map(y);let l;try{const u=i.slice(0,-1).reduce((f,m)=>f[m],e),d=i.reduce((f,m)=>f[m],e);switch(a){case 0:l=d;break;case 1:u[i.slice(-1)[0]]=y(n.data.value),l=!0;break;case 2:l=d.apply(u,c);break;case 3:{const f=new d(...c);l=G(f)}break;case 4:{const{port1:f,port2:m}=new MessageChannel;U(e,m),l=B(f,[f])}break;case 5:l=void 0;break}}catch(u){l={value:u,[O]:0}}Promise.resolve(l).catch(u=>({value:u,[O]:0})).then(u=>{const[d,f]=F(u);t.postMessage(Object.assign(Object.assign({},d),{id:s}),f),a===5&&(t.removeEventListener("message",r),z(t))})}),t.start&&t.start()}function ae(e){return e.constructor.name==="MessagePort"}function z(e){ae(e)&&e.close()}function V(e,t){return L(e,[],t)}function E(e){if(e)throw new Error("Proxy has been released and is not useable")}function L(e,t=[],r=function(){}){let n=!1;const s=new Proxy(r,{get(a,i){if(E(n),i===j)return()=>_(e,{type:5,path:t.map(c=>c.toString())}).then(()=>{z(e),n=!0});if(i==="then"){if(t.length===0)return{then:()=>s};const c=_(e,{type:0,path:t.map(l=>l.toString())}).then(y);return c.then.bind(c)}return L(e,[...t,i])},set(a,i,c){E(n);const[l,u]=F(c);return _(e,{type:1,path:[...t,i].map(d=>d.toString()),value:l},u).then(y)},apply(a,i,c){E(n);const l=t[t.length-1];if(l===D)return _(e,{type:4}).then(y);if(l==="bind")return L(e,t.slice(0,-1));const[u,d]=N(c);return _(e,{type:2,path:t.map(f=>f.toString()),argumentList:u},d).then(y)},construct(a,i){E(n);const[c,l]=N(i);return _(e,{type:3,path:t.map(u=>u.toString()),argumentList:c},l).then(y)}});return s}function oe(e){return Array.prototype.concat.apply([],e)}function N(e){const t=e.map(F);return[t.map(r=>r[0]),oe(t.map(r=>r[1]))]}var H=new WeakMap;function B(e,t){return H.set(e,t),e}function G(e){return Object.assign(e,{[C]:!0})}function ce(e,t=self,r="*"){return{postMessage:(n,s)=>e.postMessage(n,r,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function F(e){for(const[t,r]of T)if(r.canHandle(e)){const[n,s]=r.serialize(e);return[{type:3,name:t,value:n},s]}return[{type:0,value:e},H.get(e)||[]]}function y(e){switch(e.type){case 3:return T.get(e.name).deserialize(e.value);case 0:return e.value}}function _(e,t,r){return new Promise(n=>{const s=le();e.addEventListener("message",function a(i){!i.data||!i.data.id||i.data.id!==s||(e.removeEventListener("message",a),n(i.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),r)})}function le(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const ue=[g.ConsoleError,g.UncaughtException,g.UnhandledRejection];function fe(e){return!(e==null||typeof e!="object"||!("type"in e)||!ue.includes(e.type))}function p(e){const t=Object.create(null);return e?Object.assign(t,e):t}const de=new TextDecoder("latin1");function Y(e){const t={d:{}};for(const r of Object.keys(e)){const n=e[r];if("file"in n){if("symlink"in n.file){t.d[r]={f:{l:n.file.symlink}};continue}const a=n.file.contents,i=typeof a=="string"?a:de.decode(a),c=typeof a=="string"?{}:{b:!0};t.d[r]={f:{c:i,...c}};continue}const s=Y(n.directory);t.d[r]=s}return t}function q(e){const t=p();if("f"in e)throw new Error("It is not possible to export a single file in the JSON format.");if("d"in e)for(const r of Object.keys(e.d)){const n=e.d[r];"d"in n?t[r]=p({directory:q(n)}):"f"in n&&("c"in n.f?t[r]=p({file:p({contents:n.f.b?he(n.f.c):n.f.c})}):"l"in n.f&&(t[r]=p({file:p({symlink:n.f.l})})))}return t}function he(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e[r].charCodeAt(0);return t}let P=null,x=null,R={};const J=new TextDecoder,we=new TextEncoder,h=class h{constructor(t,r,n,s){o(this,"_instance");o(this,"_runtimeInfo");o(this,"fs");o(this,"_tornDown",!1);o(this,"_unsubscribeFromTokenChangedListener",()=>{});this._instance=t,this._runtimeInfo=s,this.fs=new be(r)}async spawn(t,r,n){let s=[];Array.isArray(r)?s=r:n=r;let a,i=new ReadableStream;if((n==null?void 0:n.output)!==!1){const M=ve();a=M.push,i=M.stream}let c,l,u,d;const f=S(I(a)),m=S(I(c)),Q=S(I(u)),X=await this._instance.run({command:t,args:s,cwd:n==null?void 0:n.cwd,env:n==null?void 0:n.env,terminal:n==null?void 0:n.terminal},m,Q,f);return new ge(X,i,l,d)}async export(t,r){const n={format:(r==null?void 0:r.format)??"json",includes:r==null?void 0:r.includes,excludes:r==null?void 0:r.excludes,external:!0},s=await this._instance.serialize(t,n);if(n.format==="json"){const a=JSON.parse(J.decode(s));return q(a)}return s}on(t,r){if(t==="preview-message"){const a=r;r=i=>{fe(i)&&a(i)}}const{listener:n,subscribe:s}=ke(r);return s(this._instance.on(t,w.proxy(n)))}mount(t,r){const n=t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):we.encode(JSON.stringify(Y(t)));return this._instance.loadFiles(w.transfer(n,[n.buffer]),{mountPoints:r==null?void 0:r.mountPoint})}setPreviewScript(t,r){return this._instance.setPreviewScript(t,r)}get path(){return this._runtimeInfo.path}get workdir(){return this._runtimeInfo.cwd}teardown(){if(this._tornDown)throw new Error("WebContainer already torn down");this._tornDown=!0,this._unsubscribeFromTokenChangedListener();const t=async()=>{try{await this.fs._teardown(),await this._instance.teardown()}finally{this._instance[w.releaseProxy](),h._instance===this&&(h._instance=null)}};h._teardownPromise=t()}static async boot(t={}){await this._teardownPromise,h._teardownPromise=null;const{workdirName:r}=t;if(window.crossOriginIsolated&&t.coep==="none"&&console.warn(`A Cross-Origin-Embedder-Policy header is required in cross origin isolated environments.
Set the 'coep' option to 'require-corp'.`),r!=null&&r.includes("/")||r===".."||r===".")throw new Error("workdirName should be a valid folder name");for(;P;)await P;if(h._instance)throw new Error("Only a single WebContainer instance can be booted");const n=Ee(t);P=n.catch(()=>{});try{const s=await n;return h._instance=s,s}finally{P=null}}};o(h,"_instance",null),o(h,"_teardownPromise",null);let A=h;const me=1,ye=2;class _e{constructor(t,r){o(this,"name");o(this,"_type");this.name=t,this._type=r}isFile(){return this._type===me}isDirectory(){return this._type===ye}}class pe{constructor(t,r,n,s){o(this,"_apiClient");o(this,"_path");o(this,"_options");o(this,"_listener");o(this,"_wrappedListener");o(this,"_watcher");o(this,"_closed",!1);this._apiClient=t,this._path=r,this._options=n,this._listener=s,this._apiClient._watchers.add(this),this._wrappedListener=(a,i)=>{this._listener&&!this._closed&&this._listener(a,i)},this._apiClient._fs.watch(this._path,this._options,S(this._wrappedListener)).then(a=>{if(this._watcher=a,this._closed)return this._teardown()}).catch(console.error)}async close(){this._closed||(this._closed=!0,this._apiClient._watchers.delete(this),await this._teardown())}async _teardown(){var t;await((t=this._watcher)==null?void 0:t.close().finally(()=>{var r;(r=this._watcher)==null||r[w.releaseProxy]()}))}}class ge{constructor(t,r,n,s){o(this,"output");o(this,"input");o(this,"exit");o(this,"_process");o(this,"stdout");o(this,"stderr");this.output=r,this._process=t,this.input=new WritableStream({write:a=>{var i;(i=this._getProcess())==null||i.write(a).catch(()=>{})}}),this.exit=this._onExit(),this.stdout=n,this.stderr=s}kill(){var t;(t=this._process)==null||t.kill()}resize(t){var r;(r=this._getProcess())==null||r.resize(t)}async _onExit(){var t;try{return await this._process.onExit}finally{(t=this._process)==null||t[w.releaseProxy](),this._process=null}}_getProcess(){return this._process==null&&console.warn("This process already exited"),this._process}}class be{constructor(t){o(this,"_fs");o(this,"_watchers",new Set([]));this._fs=t}rm(...t){return this._fs.rm(...t)}async readFile(t,r){return await this._fs.readFile(t,r)}async rename(t,r){return await this._fs.rename(t,r)}async writeFile(t,r,n){if(r instanceof Uint8Array){const s=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);r=w.transfer(new Uint8Array(s),[s])}await this._fs.writeFile(t,r,n)}async readdir(t,r){const n=await this._fs.readdir(t,r);return xe(n)||Se(n)?n:n.map(a=>new _e(a.name,a["Symbol(type)"]))}async mkdir(t,r){return await this._fs.mkdir(t,r)}watch(t,r,n){return typeof r=="function"&&(n=r,r=null),new pe(this,t,r,n)}async _teardown(){this._fs[w.releaseProxy](),await Promise.all([...this._watchers].map(t=>t.close()))}}async function Ee(e){const{serverPromise:t}=Pe(e),n=await(await t).build({host:window.location.host,version:"1.6.1",workdirName:e.workdirName,forwardPreviewErrors:e.forwardPreviewErrors}),[s,a,i]=await Promise.all([n.fs(),n.previewScript(),n.runtimeInfo()]);return new A(n,s,a,i)}function I(e){if(e!=null)return t=>{t instanceof Uint8Array?e(J.decode(t)):t==null&&e(null)}}function S(e){if(e!=null)return w.proxy(e)}function Pe(e){if(x!=null)return e.coep!==R.coep&&(console.warn(`Attempting to boot WebContainer with 'coep: ${e.coep}'`),console.warn(`First boot had 'coep: ${R.coep}', new settings will not take effect!`)),{serverPromise:x};e.coep&&k.setQueryParam("coep",e.coep),e.experimentalNode&&k.setQueryParam("experimental_node","1");const t=document.createElement("iframe");t.style.display="none",t.setAttribute("allow","cross-origin-isolated");const r=k.url;t.src=r.toString();const{origin:n}=r;return R={...e},x=new Promise(s=>{const a=i=>{if(i.origin!==n)return;const{data:c}=i;if(c.type==="init"){s(w.wrap(i.ports[0]));return}if(c.type==="warning"){console[c.level].call(console,c.message);return}};window.addEventListener("message",a)}),document.body.insertBefore(t,null),{serverPromise:x}}function xe(e){return typeof e[0]=="string"}function Se(e){return e[0]instanceof Uint8Array}function ve(){let e=null;return{stream:new ReadableStream({start(n){e=n}}),push:n=>{n!=null?e==null||e.enqueue(n):(e==null||e.close(),e=null)}}}function ke(e){let t=!1,r=()=>{};return{subscribe(s){return s.then(a=>{r=a,t&&r()}),()=>{t=!0,r()}},listener:(...s)=>{t||e(...s)}}}export{g as PreviewMessageType,A as WebContainer,fe as isPreviewMessage};
