import{m as x,l as m,aH as y,k as R,aI as A,aJ as E,aB as T,av as D,j as s,E as j,r as h,aD as k}from"./index-BIH90SC5.js";import{d as b,B as S,b as C}from"./button-BcLPkHor.js";import{B}from"./index-r_z6yYY1.js";import{S as M,c as I}from"./Subject-B7zEiqhL.js";import{V as O}from"./opfs-key-D0VDwJ2Y.js";import{S as N}from"./index-B4g9YTQJ.js";import{A as H}from"./index-Brs4_diQ.js";import"./iconBase-Bx-3qh5G.js";import"./index--gd1Bdtg.js";import"./is-phone-C3X7a2hG.js";import"./index-Bq8EmaxU.js";import"./index-B77HlWHk.js";import"./asyncToGenerator-C6lzLSqT.js";import"./reactNode-CzgveA51.js";const{useStore:Re,useStoreSlice:p,getStore:i}=x((e,r,o)=>({name:null,stream:null,recorder:null,blob:null,url:null,setName:t=>e({name:t}),setStream:t=>e({stream:t}),setRecorder:t=>e({recorder:t}),setBlob:t=>e({blob:t}),setUrl:t=>e({url:t}),clear:()=>e(o.getInitialState())}));var f=(e=>(e.RECORD_END="RECORD_END",e))(f||{});const w=new M;function _(e){w.next(e),m.event("recording-action",e)}const P=I(w);function $(e){return e?`${O}${e}`:""}function F(e){const r=new AudioContext,o=r.createMediaStreamDestination();return e.filter(t=>t.getAudioTracks().length).forEach(t=>{r.createMediaStreamSource(t).connect(o)}),o.stream}async function V(){try{const e=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:{channelCount:2}}),r=await navigator.mediaDevices.getUserMedia({audio:{channelCount:2}}),o=F([e,r]),t=new MediaStream;return e.getVideoTracks().forEach(n=>t.addTrack(n)),o.getTracks().forEach(n=>t.addTrack(n)),{stream:t,stopTraces(){e.getTracks().forEach(n=>n.stop()),r.getTracks().forEach(n=>n.stop())}}}catch(e){return m.error("get-screen-and-audio-stream",e.message),{}}}const v=E(()=>["video/webm;codecs=daala,opus","video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm;codecs=h264","video/webm","video/mp4","video/mpeg"].find(e=>MediaRecorder.isTypeSupported(e))||"");function U(e){const r=v();if(!r)throw new Error("No supported mime type found");return new MediaRecorder(e,{mimeType:r})}const{startRecording:L,stopRecording:q,listener:G}=(()=>{let e=[];const r=!D();let o=null,t;function n(a){if(r)return e.push(a);o.write(a)}async function d(){if(r)return;const a=i().name;a&&(t=$(`${a}.webm`),o=await T(t))}return{startRecording:async a=>{await d();const u=U(a);return u.start(100),u},stopRecording:a=>{a.stop()},listener:(a,u)=>{a.ondataavailable=l=>{n(l.data)},a.onstop=async()=>{a.stop();const l=new Blob(e,{type:v()});e=[],await(o==null?void 0:o.close()),u(t,l)}}}})();async function J(){const{stream:e,stopTraces:r}=await V();if(!e)return;const{recorder:o,setStream:t,setRecorder:n}=i();if(o)return;t(e);for(let c=5;c>0;c--)R().showMessage({content:`${c}秒后开始录制`,duration:1}),await A(1e3);R().showMessage({content:"开始录制"});const d=await L(e);G(d,(c,g)=>{r==null||r(),c?i().setUrl(c):i().setBlob(g),_({id:"recording-end",type:f.RECORD_END})}),n(d)}async function W(){const{recorder:e}=i();e&&q(e)}async function Y(){const{blob:e}=i();return e?y(e):""}const z=b.span``;function K(){const{name:e,recorder:r}=p(["name","recorder"]);return e?s.jsx(B,{buttons:[{text:"保存录制",$presetTheme:S.DANGER,hidden:!r,onClick:()=>W()},{text:"开始录制",$presetTheme:S.PRIMARY,hidden:!!r,onClick:()=>J()}]}):s.jsx(z,{children:"请先输入视频名称"})}const Q=b.input`
  all: inherit;
  border: none;
  outline: none;
`,X=e=>{i().setName(e.target.value.trim())},Z=j(X,300);function ee(e){const{readOnly:r}=e,{name:o,recorder:t}=p(["name","recorder"]);return s.jsx(C,{children:s.jsx(N,{when:!r||!!t,fullback:s.jsx("span",{children:o}),children:()=>s.jsx(Q,{defaultValue:o||"",placeholder:"请输入笔记标题",onChange:Z})})})}function he(){const e=h.useRef(null),{stream:r}=p("stream");return P(()=>{const{addRecord:o}=k(),{name:t,url:n,clear:d}=i();if(t){if(d(),setTimeout(()=>{console.debug(i())},1e3),n)return o({name:t,url:n});Y().then(c=>o({name:t,content:c}))}},f.RECORD_END),h.useEffect(()=>{e.current&&r&&(e.current.srcObject=r)},[r]),s.jsx(H,{onFirstAppear:()=>m.appear("recording"),children:s.jsx("video",{ref:e,muted:!0,autoPlay:!0})})}const Se={title:"录制器",needBackIcon:!0,rightArea:s.jsx(K,{}),titleArea:s.jsx(ee,{})};export{he as Component,Se as handle};
